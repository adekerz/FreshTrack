-- ============================================================================
-- Migration 027: Уникальный индекс на marsha_code для активных отелей
-- ============================================================================
-- Проблема: При деактивации/реактивации отелей возможны коллизии marsha_code
-- Решение: Частичный уникальный индекс только для активных отелей
-- ============================================================================

-- Уникальный индекс: один marsha_code может быть только у одного активного отеля
CREATE UNIQUE INDEX IF NOT EXISTS unique_active_marsha 
ON hotels (marsha_code) 
WHERE is_active = true;

-- Комментарий к индексу
COMMENT ON INDEX unique_active_marsha IS 
'Гарантирует уникальность marsha_code среди активных отелей. 
Деактивированные отели могут иметь дублирующийся код.';
