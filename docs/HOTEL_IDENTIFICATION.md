# –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–µ–ª–µ–π –≤ FreshTrack

## 1. –¢–∏–ø—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤

| –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä            | –¢–∏–ø        | –û–ø–∏—Å–∞–Ω–∏–µ                  | –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å              |
| ------------------------ | ---------- | ------------------------- | ------------------------- |
| **`hotels.id`**          | UUID       | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á –≤ –ë–î       | –ì–ª–æ–±–∞–ª—å–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π      |
| **`hotels.marsha_code`** | VARCHAR(5) | 5-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥ Marriott | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö |
| ~~`hotels.code`~~        | ‚ùå –£–î–ê–õ–Å–ù  | –ë—ã–ª 6-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥      | –ú–∏–≥—Ä–∞—Ü–∏—è 019 —É–¥–∞–ª–∏–ª–∞      |

**–¢–∞–∫–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**

- **`marsha_codes`** (—Ç–∞–±–ª–∏—Ü–∞) ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ MARSHA –∫–æ–¥–æ–≤ Marriott (master registry)

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê –ê–†–•–ò–¢–ï–ö–¢–£–†–´

### –ü—Ä–∞–≤–∏–ª–æ 1: –î–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∞–≤–¥—ã –¥–ª—è MARSHA

| –¢–∞–±–ª–∏—Ü–∞              | –†–æ–ª—å                | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ                                  |
| -------------------- | ------------------- | ----------------------------------------------- |
| `marsha_codes`       | **Master registry** | –ß–µ—Ä–µ–∑ permissions `marsha_codes:create/assign`  |
| `hotels.marsha_code` | **Snapshot**        | **–¢–û–õ–¨–ö–û** —á–µ—Ä–µ–∑ `marsha_code_id` (—Ç—Ä–∏–≥–≥–µ—Ä –ë–î!) |

**–ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä—è–º–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–º–∏–≥—Ä–∞—Ü–∏—è 029):**

```sql
-- –¢—Ä–∏–≥–≥–µ—Ä –∑–∞–ø—Ä–µ—â–∞–µ—Ç: UPDATE hotels SET marsha_code = 'XXXXX';
-- –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ: UPDATE hotels SET marsha_code_id = <uuid>;
-- –ü—Ä–∏ —Å–º–µ–Ω–µ marsha_code_id –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç marsha_code
```

**Permissions –¥–ª—è marsha_codes:**
| Permission | –û–ø–∏—Å–∞–Ω–∏–µ | –†–æ–ª–∏ |
| ---------------------- | ------------------------------------- | ------------------ |
| `marsha_codes:view` | –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ | SUPER_ADMIN, HOTEL_ADMIN |
| `marsha_codes:create` | –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–¥–æ–≤ | SUPER_ADMIN |
| `marsha_codes:assign` | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–¥–∞ –æ—Ç–µ–ª—é | SUPER_ADMIN |
| `marsha_codes:unassign`| –û—Ç–≤—è–∑–∫–∞ –∫–æ–¥–∞ –æ—Ç –æ—Ç–µ–ª—è | SUPER_ADMIN |

> ‚òùÔ∏è –ù–∏–∫–∞–∫–∏—Ö hardcoded —Ä–æ–ª–µ–π –≤ –∫–æ–¥–µ ‚Äî —Ç–æ–ª—å–∫–æ permissions!

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å (–º–∏–≥—Ä–∞—Ü–∏—è 027):**

```sql
CREATE UNIQUE INDEX unique_active_marsha
ON hotels (marsha_code)
WHERE is_active = true;
```

> ‚òùÔ∏è –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–ª–∏–∑–∏–∏ –ø—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏/—Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ—Ç–µ–ª–µ–π.

---

### –ü—Ä–∞–≤–∏–ª–æ 2: `marsha_code` –≤ API ‚Äî –¢–û–õ–¨–ö–û –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**‚úÖ –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:**

```
GET  /api/auth/validate-hotel-code?code=TSERZ
POST /api/auth/register  (body: { hotelCode: "TSERZ", ... })
```

**‚ùå –ó–ê–ü–†–ï–©–ï–ù–û –ø—Ä–∏–Ω–∏–º–∞—Ç—å `marsha_code` –≤:**

- `/api/products*`
- `/api/batches*`
- `/api/inventory*`
- `/api/departments*`
- –õ—é–±—ã–µ –±–∏–∑–Ω–µ—Å-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

**–ü–æ—á–µ–º—É:** –ß–µ—Ä–µ–∑ 6 –º–µ—Å—è—Ü–µ–≤ –∫—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞–µ—Ç `GET /api/products?marsha=TSERZ` ‚Äî –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ–º–∞–µ—Ç—Å—è.

---

### –ü—Ä–∞–≤–∏–ª–æ 3: –í–Ω–µ—à–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (OPERA, SAP, PMS)

```
hotel_id     ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (FreshTrack) ‚Äî –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô!
marsha_code  ‚Äî –≤–Ω–µ—à–Ω–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (Marriott)
external_ids ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –í–°–ï–• –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
```

**–í–∞–∂–Ω–æ:** –í–Ω–µ—à–Ω–∏–µ –∫–æ–¥—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ **–æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ** `external_ids`, –∞ –Ω–µ –≤ JSONB:

| –°–∏—Å—Ç–µ–º–∞ | Lifecycle      | –ú–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è?               |
| ------- | -------------- | ----------------------------- |
| MARSHA  | –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π     | ‚ùå –ù–µ—Ç (–∫–æ–¥ –æ—Ç–µ–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω) |
| OPERA   | –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π    | ‚úÖ –ü—Ä–∏ —Å–º–µ–Ω–µ PMS              |
| SAP     | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π | ‚úÖ –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ ERP         |

> üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. —Ä–∞–∑–¥–µ–ª 7: `external_ids`

---

## 2. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä ‚Äî `hotel_id` (UUID)

**–ü–æ—á–µ–º—É UUID:**

- –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–≤—è–∑–∞–Ω—ã —á–µ—Ä–µ–∑ `hotel_id UUID REFERENCES hotels(id)`
- Foreign keys: `users.hotel_id`, `departments.hotel_id`, `products.hotel_id`, `batches.hotel_id`, etc.
- –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: `WHERE hotel_id = $1`
- –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ: `ON DELETE CASCADE`

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ–ø–µ—Ä–∏—Ä—É–µ—Ç –¢–û–õ–¨–ö–û `hotel_id` (UUID).

---

## 3. –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `marsha_code`

| –ú–µ—Å—Ç–æ                        | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ                                                       | –≠–Ω–¥–ø–æ–∏–Ω—Ç                            |
| ---------------------------- | ------------------------------------------------------------------- | ----------------------------------- |
| **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** | –ü–æ–∏—Å–∫ –æ—Ç–µ–ª—è: `WHERE UPPER(marsha_code) = $1` ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ `hotel_id` | `POST /api/auth/register`           |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞**           | UI –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –æ—Ç–µ–ª—è                                     | `GET /api/auth/validate-hotel-code` |
| **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI**         | –ö–∞–∫ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π –∫–æ–¥ –æ—Ç–µ–ª—è                                      | ‚Äî                                   |

> ‚ö†Ô∏è **–í–ê–ñ–ù–û:** –≠—Ç–æ –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ï –º–µ—Å—Ç–∞ –≥–¥–µ `marsha_code` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∏–∑–≤–Ω–µ!

**–õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:**

```javascript
// auth.service.js
const hotelByCode = await dbQuery(
  `
  SELECT id FROM hotels 
  WHERE UPPER(marsha_code) = $1 AND is_active = true
`,
  [codeUpper]
)

hotelId = hotelByCode.rows[0].id // –î–∞–ª—å—à–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û hotel_id
```

---

## 4. –ö–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç: TSERZ
         ‚Üì
SELECT id FROM hotels WHERE UPPER(marsha_code) = 'TSERZ'
         ‚Üì
–ü–æ–ª—É—á–µ–Ω: hotel_id = 'e4696fdc-8643-401a-b2c6-881ac46c5509'
         ‚Üì
INSERT INTO users (..., hotel_id) VALUES (..., hotel_id)
INSERT INTO join_requests (user_id, hotel_id) VALUES (...)
         ‚Üì
–î–∞–ª—å–Ω–µ–π—à–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ hotel_id
```

---

## 5. –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `marsha_code`

‚ùå **–ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:**

| –û–ø–µ—Ä–∞—Ü–∏—è                                                | –ü–æ—á–µ–º—É –∑–∞–ø—Ä–µ—â–µ–Ω–æ                 |
| ------------------------------------------------------- | -------------------------------- |
| `WHERE marsha_code = $1` –≤ –±–∏–∑–Ω–µ—Å-–∑–∞–ø—Ä–æ—Å–∞—Ö              | FK —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ hotel_id          |
| –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤/–ø–∞—Ä—Ç–∏–π –ø–æ marsha_code              | –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞, –Ω–µ—Ç FK              |
| –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ marsha_code                       | –ù–∞—Ä—É—à–∏—Ç multi-tenant –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É |
| –ü–µ—Ä–µ–¥–∞—á–∞ marsha_code –≤ API (–∫—Ä–æ–º–µ /validate-hotel-code) | API –æ–∂–∏–¥–∞–µ—Ç hotel_id             |

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**

```sql
-- ‚úÖ –î–ê
WHERE b.hotel_id = '...'

-- ‚ùå –ù–ï–¢
WHERE h.marsha_code = 'TSERZ'
```

---

## 6. –¢–∞–±–ª–∏—Ü–∞ `marsha_codes` vs `hotels.marsha_code`

| –¢–∞–±–ª–∏—Ü–∞              | –†–æ–ª—å                | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                               |
| -------------------- | ------------------- | ---------------------------------------- |
| `marsha_codes`       | **Master registry** | –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –í–°–ï–• –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–¥–æ–≤ Marriott |
| `hotels.marsha_code` | **Snapshot**        | –ö–æ–ø–∏—è –∫–æ–¥–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ç–µ–ª—è         |

**–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

- ‚ùå –ü—Ä—è–º–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `hotels.marsha_code` ‚Äî **–ó–ê–ü–†–ï–©–ï–ù–û**
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –≤—ã–±–æ—Ä `marsha_code_id` –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞

**–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç–µ–ª—è:**

1. –í—ã–±–∏—Ä–∞–µ—Ç—Å—è –∫–æ–¥ –∏–∑ `marsha_codes` (—á–µ—Ä–µ–∑ `marsha_code_id`)
2. –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ `hotels.marsha_code` (snapshot)
3. –í `marsha_codes` –ø–æ–º–µ—á–∞–µ—Ç—Å—è `is_assigned = true`

---

## –ò—Ç–æ–≥

```
marsha_code ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –ø–æ–∏—Å–∫–∞ hotel_id
hotel_id    ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –í–°–ï–ì–û –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ
```

---

## 7. –¢–∞–±–ª–∏—Ü–∞ `external_ids` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

**–ú–∏–≥—Ä–∞—Ü–∏—è 028** —Å–æ–∑–¥–∞—ë—Ç **–û–¢–î–ï–õ–¨–ù–£–Æ –¢–ê–ë–õ–ò–¶–£** (–Ω–µ JSONB!) –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤:

```sql
CREATE TABLE external_ids (
  id UUID PRIMARY KEY,
  hotel_id UUID REFERENCES hotels(id) ON DELETE CASCADE,
  system external_system NOT NULL,  -- ENUM: 'MARSHA', 'OPERA', 'SAP', 'PMS', 'ORACLE', 'OTHER'
  external_code VARCHAR(50) NOT NULL,
  metadata JSONB DEFAULT '{}',       -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å—Ç—Ä–æ–≥–æ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ!)
  is_primary BOOLEAN DEFAULT false,
  verified_at TIMESTAMP,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,

  UNIQUE (system, external_code),    -- –û–¥–∏–Ω –∫–æ–¥ –Ω–∞ —Å–∏—Å—Ç–µ–º—É –≥–ª–æ–±–∞–ª—å–Ω–æ
  UNIQUE (hotel_id, system)          -- –û–¥–∏–Ω –æ—Ç–µ–ª—å = –æ–¥–∏–Ω –∫–æ–¥ –≤ –∫–∞–∂–¥–æ–π —Å–∏—Å—Ç–µ–º–µ
);
```

### ‚ö†Ô∏è –ü–æ—á–µ–º—É –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞, –∞ –Ω–µ JSONB?

| –ê—Å–ø–µ–∫—Ç                 | JSONB `{"marsha": "X"}` | –¢–∞–±–ª–∏—Ü–∞ `external_ids`                 |
| ---------------------- | ----------------------- | -------------------------------------- |
| **Audit trail**        | ‚ùå –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å     | ‚úÖ –ü–æ–ª–Ω—ã–π history                      |
| **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã** | ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ           | ‚úÖ `UNIQUE(system, code)`              |
| **–†–∞–∑–Ω—ã–µ lifecycle**   | ‚ùå –í—Å—ë –≤–º–µ—Å—Ç–µ           | ‚úÖ OPERA –º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å—Å—è, MARSHA ‚Äî –Ω–µ—Ç |
| **FK constraints**     | ‚ùå –ù–µ—Ç                  | ‚úÖ `REFERENCES hotels(id)`             |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤**    | ‚ùå Runtime              | ‚úÖ ENUM –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î                   |

### Permissions –¥–ª—è external_ids

| Permission            | –û–ø–∏—Å–∞–Ω–∏–µ                   |
| --------------------- | -------------------------- |
| `external_ids:view`   | –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–¥–æ–≤     |
| `external_ids:manage` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏–º–∏ –∫–æ–¥–∞–º–∏ |

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```sql
-- –ù–∞–π—Ç–∏ –æ—Ç–µ–ª—å –ø–æ –∫–æ–¥—É OPERA
SELECT h.* FROM hotels h
JOIN external_ids e ON e.hotel_id = h.id
WHERE e.system = 'OPERA' AND e.external_code = 'AST001';

-- –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∫–æ–¥—ã –æ—Ç–µ–ª—è
SELECT system, external_code, verified_at
FROM external_ids
WHERE hotel_id = 'uuid';
```

---

## –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã hotels (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è)

```sql
CREATE TABLE hotels (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  -- code VARCHAR(50) -- –£–î–ê–õ–Å–ù –º–∏–≥—Ä–∞—Ü–∏–µ–π 019
  address TEXT,
  city VARCHAR(100),
  country VARCHAR(100) DEFAULT 'Kazakhstan',
  timezone VARCHAR(50) DEFAULT 'Asia/Almaty',
  is_active BOOLEAN DEFAULT TRUE,
  settings JSONB,
  marsha_code VARCHAR(5),           -- 5-—Å–∏–º–≤–æ–ª—å–Ω—ã–π MARSHA –∫–æ–¥
  marsha_code_id UUID REFERENCES marsha_codes(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## –ú–∏–≥—Ä–∞—Ü–∏–∏ (–∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)

| #   | –§–∞–π–ª                             | –û–ø–∏—Å–∞–Ω–∏–µ                                   |
| --- | -------------------------------- | ------------------------------------------ |
| 018 | `marsha_codes.sql`               | –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ MARSHA –∫–æ–¥–æ–≤                    |
| 019 | `remove_hotel_legacy_code.sql`   | –£–¥–∞–ª—ë–Ω `hotels.code` (legacy)              |
| 027 | `unique_active_marsha_index.sql` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ç–µ–ª–µ–π      |
| 028 | `external_ids_integration.sql`   | –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º (OPERA, SAP...) |
| 029 | `protect_marsha_code.sql`        | –¢—Ä–∏–≥–≥–µ—Ä –∑–∞—â–∏—Ç—ã + permissions               |

---

## –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

| –û—Ç–µ–ª—å                    | marsha_code | hotel_id                |
| ------------------------ | ----------- | ----------------------- |
| The Ritz-Carlton, Astana | TSERZ       | (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ seed) |
