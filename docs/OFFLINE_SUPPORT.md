# Offline Support & Cache Persistence

## Overview

FreshTrack —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É –≤ offline —Ä–µ–∂–∏–º–µ –±–ª–∞–≥–æ–¥–∞—Ä—è React Query Persistence –∏ —É–º–Ω–æ–º—É –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é.

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `localStorage`
- –ö—ç—à –∂–∏–≤–µ—Ç 24 —á–∞—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 5MB

### 2. –†–∞–±–æ—Ç–∞ offline
- –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–∫–∞–ª—å–Ω–æ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

### 3. –£–º–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refetch –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û—á–µ—Ä–µ–¥—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è offline —Ä–µ–∂–∏–º–∞

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ queryClient.js          # Query client —Å networkMode: 'offlineFirst'
‚îÇ   ‚îî‚îÄ‚îÄ queryPersistence.js     # Persistence configuration
‚îÇ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OfflineIndicator.jsx # UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä offline —Å—Ç–∞—Ç—É—Å–∞
‚îÇ   ‚îî‚îÄ‚îÄ settings/
‚îÇ       ‚îî‚îÄ‚îÄ CacheManagement.jsx  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º
‚îÇ
‚îî‚îÄ‚îÄ hooks/
    ‚îî‚îÄ‚îÄ useInventory.js          # Hooks —Å offline –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ persistence

```javascript
// src/lib/queryPersistence.js
persistQueryClient({
  queryClient,
  persister,
  maxAge: 24 * 60 * 60 * 1000, // 24 —á–∞—Å–∞
  
  dehydrateOptions: {
    shouldDehydrateQuery: (query) => {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ queries
      return query.state.status === 'success'
    }
  }
})
```

### Network Mode

```javascript
// src/lib/queryClient.js
defaultOptions: {
  queries: {
    networkMode: 'offlineFirst', // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à, –¥–∞–∂–µ offline
    refetchOnReconnect: true      // Auto-sync –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
  }
}
```

## üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

### –ö–æ–≥–¥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–µ—Ä—è–µ—Ç—Å—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2. –ü–æ—è–≤–ª—è–µ—Ç—Å—è –∂–µ–ª—Ç—ã–π –±–∞–Ω–Ω–µ—Ä:        ‚îÇ
‚îÇ    "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è     ‚îÇ
‚îÇ     —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏"  ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ 3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:  ‚îÇ
‚îÇ    ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—ç—à–∞       ‚îÇ
‚îÇ    ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏–π –ª–æ–∫–∞–ª—å–Ω–æ    ‚îÇ
‚îÇ    ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ 4. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏ sync         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–≥–¥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 2. –ó–µ–ª–µ–Ω—ã–π –±–∞–Ω–Ω–µ—Ä (3 —Å–µ–∫):          ‚îÇ
‚îÇ    "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"      ‚îÇ
‚îÇ    "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è..."               ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ 3. React Query –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:       ‚îÇ
‚îÇ    ‚úÖ Invalidates queries           ‚îÇ
‚îÇ    ‚úÖ Refetch –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö           ‚îÇ
‚îÇ    ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è      ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ 4. –ë–∞–Ω–Ω–µ—Ä –∏—Å—á–µ–∑–∞–µ—Ç                  ‚îÇ
‚îÇ 5. –†–∞–±–æ—Ç–∞ –∫–∞–∫ –æ–±—ã—á–Ω–æ                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º

### –ß–µ—Ä–µ–∑ UI (Settings ‚Üí Cache)

–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç:
- –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞
- –£–≤–∏–¥–µ—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö queries
- –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ

```javascript
import { 
  getPersistedCacheInfo, 
  clearPersistedCache,
  getPersistedCacheSize 
} from '../lib/queryPersistence'

// –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—ç—à–µ
const info = getPersistedCacheInfo()
console.log(info)
// {
//   exists: true,
//   size: 245678,
//   sizeFormatted: "239.92 KB",
//   queries: 12,
//   timestamp: "2026-01-21T10:30:00Z"
// }

// –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä
const size = getPersistedCacheSize()
console.log(`Cache size: ${size} bytes`)

// –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
clearPersistedCache()
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

```javascript
// ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–µ queries:
- batches (–ø–∞—Ä—Ç–∏–∏)
- departments (–æ—Ç–¥–µ–ª—ã)
- categories (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
- products (—Ç–æ–≤–∞—Ä—ã)
- stats (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)

// ‚ùå –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
- Queries –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ—à–∏–±–∫–∏
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ queries (queryKey[0] === 'temp')
- –ú—É—Ç–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ queries)
```

### –õ–∏–º–∏—Ç—ã

- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç**: 24 —á–∞—Å–∞
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä**: 5 MB
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è stale-while-revalidate

```javascript
// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ –∫—ç—à–∞:
1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage (instant)
2. –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ stale
3. –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π refetch
4. –û–±–Ω–æ–≤–ª—è–µ–º UI –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ offline —Ä–µ–∂–∏–º–∞

### –°–ø–æ—Å–æ–± 1: Chrome DevTools
```
1. –û—Ç–∫—Ä—ã—Ç—å DevTools (F12)
2. Network tab
3. Throttling ‚Üí Offline
4. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
5. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –∏–∑ –∫—ç—à–∞
```

### –°–ø–æ—Å–æ–± 2: –û—Ç–∫–ª—é—á–∏—Ç—å Wi-Fi/Ethernet
```
1. –û—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏–∑ localStorage
4. –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–∏—é ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ
5. –í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
```

### –°–ø–æ—Å–æ–± 3: Service Worker (PWA)
```javascript
// –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ public/sw.js
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((response) => {
      return response || fetch(event.request)
    })
  )
})
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### React Query DevTools

–í development —Ä–µ–∂–∏–º–µ:
1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ù–∞–π—Ç–∏ –∏–∫–æ–Ω–∫—É React Query (bottom-right)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - **Queries tab**: –ö–∞–∫–∏–µ queries –≤ –∫—ç—à–µ
   - **Cache tab**: –†–∞–∑–º–µ—Ä –∫—ç—à–∞
   - **Mutations tab**: –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞

```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage
console.log(localStorage.getItem('FRESHTRACK_QUERY_CACHE'))

// –†–∞–∑–º–µ—Ä –∫—ç—à–∞
const cache = localStorage.getItem('FRESHTRACK_QUERY_CACHE')
console.log(`Cache size: ${(cache.length / 1024).toFixed(2)} KB`)

// –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
const data = JSON.parse(cache)
console.log('Queries count:', data.clientState?.queries?.length)
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
- ‚ùå –¢–æ–∫–µ–Ω—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç httpOnly cookies)
- ‚ùå –ü–∞—Ä–æ–ª–∏
- ‚ùå Sensitive user data
- ‚ùå –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã

### –ß—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
- ‚úÖ –°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–∏–π (–ø—É–±–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç–µ–ª—è)
- ‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–æ—Ç–¥–µ–ª—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ UI preferences

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### Selective persistence

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å persistence –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ query:

```javascript
useQuery({
  queryKey: ['sensitive-data'],
  queryFn: fetchSensitiveData,
  meta: {
    persist: false // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ localStorage
  }
})
```

### –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞

```javascript
import { useQueryClient } from '@tanstack/react-query'

const queryClient = useQueryClient()

// –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
queryClient.clear()

// –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π query
queryClient.removeQueries({ queryKey: ['batches'] })

// –û—á–∏—Å—Ç–∏—Ç—å persisted –∫—ç—à
import { clearPersistedCache } from '../lib/queryPersistence'
clearPersistedCache()
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Load time —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ë–µ–∑ –∫—ç—à–∞ | –° –∫—ç—à–µ–º | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|----------|---------|-----------|
| First load | 800ms | 800ms | - |
| Reload (cache hit) | 800ms | <50ms | **16x** |
| Offline load | ‚ùå Error | <50ms | **‚àû** |
| Tab restore | 800ms | <50ms | **16x** |

### Cache hit ratio

–ü–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- **Day 1**: ~20% cache hits
- **Day 3**: ~60% cache hits
- **Week 1**: ~80% cache hits

## üêõ Troubleshooting

### Cache –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–∞–Ω–Ω—ã–µ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage –≤ DevTools
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ `setupPersistence` –≤—ã–∑–≤–∞–Ω –≤ `main.jsx`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç localStorage (5MB)

### Stale data –ø–æ—Å–ª–µ offline

**–ü—Ä–æ–±–ª–µ–º–∞**: –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// Queries –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ stale –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ refetchOnReconnect: true –≤ queryClient
```

### LocalStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω

**–ü—Ä–æ–±–ª–µ–º–∞**: `QuotaExceededError`

**–†–µ—à–µ–Ω–∏–µ**:
1. –ó–∞–π—Ç–∏ –≤ Settings ‚Üí Cache
2. –ù–∞–∂–∞—Ç—å "–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à"
3. –ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å maxAge –≤ persistence config

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SSE (Server-Sent Events)

FreshTrack –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SSE –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è:

```javascript
// –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data)
  
  // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ queries
  if (data.type === 'BATCH_UPDATED') {
    queryClient.invalidateQueries({ 
      queryKey: queryKeys.batches(data.hotelId) 
    })
  }
}
```

–ü—Ä–∏ offline —Ä–µ–∂–∏–º–µ:
- SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ
- –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ SSE –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- React Query refetch –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ

## üì± PWA Integration

Offline support –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Service Worker:

```javascript
// public/sw.js
self.addEventListener('fetch', (event) => {
  // Cache API –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
  // React Query persistence –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
  // –î–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è offline —Ä–∞–±–æ—Ç—ã
})
```

## üéì Best Practices

### DO
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `networkMode: 'offlineFirst'` –¥–ª—è queries
- ‚úÖ –í–∫–ª—é—á–∞–π—Ç–µ `refetchOnReconnect: true`
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ OfflineIndicator –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ offline —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ

### DON'T
- ‚ùå –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ sensitive data –≤ localStorage
- ‚ùå –ù–µ –¥–µ–ª–∞–π—Ç–µ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π –∫—ç—à (>5MB)
- ‚ùå –ù–µ –ø–æ–ª–∞–≥–∞–π—Ç–µ—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –∫—ç—à –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚ùå –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üìö Resources

- [React Query Persistence](https://tanstack.com/query/latest/docs/plugins/persistQueryClient)
- [Network Mode](https://tanstack.com/query/latest/docs/guides/network-mode)
- [Offline First Apps](https://www.offlinefirst.org/)

---

**Status**: ‚úÖ Fully Implemented  
**Version**: 1.0.0  
**Last Updated**: 2026-01-21
