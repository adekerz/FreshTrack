# FreshTrack: –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ-—Ä–µ—à–µ–Ω–∏–µ)
2. [–§–∞–∑–∞ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞](#—Ñ–∞–∑–∞-0-–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞)
3. [–§–∞–∑–∞ 1: –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π](#—Ñ–∞–∑–∞-1-—Å–∏—Å—Ç–µ–º–∞-—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π)
4. [–§–∞–∑–∞ 2: –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–ª–∞–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏](#—Ñ–∞–∑–∞-2-–∫–æ–Ω—Ç–µ–∫—Å—Ç-–≤–ª–∞–¥–µ–Ω–∏—è-–¥–∞–Ω–Ω—ã–º–∏)
5. [–§–∞–∑–∞ 3: Backend –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –ª–æ–≥–∏–∫–∏](#—Ñ–∞–∑–∞-3-backend-–∫–∞–∫-–∏—Å—Ç–æ—á–Ω–∏–∫-–ª–æ–≥–∏–∫–∏)
6. [–§–∞–∑–∞ 4: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞—É–¥–∏—Ç](#—Ñ–∞–∑–∞-4-—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π-–∞—É–¥–∏—Ç)
7. [–§–∞–∑–∞ 5: Notification Engine](#—Ñ–∞–∑–∞-5-notification-engine)
8. [–§–∞–∑–∞ 6: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#—Ñ–∞–∑–∞-6-—É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)
9. [–§–∞–∑–∞ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–∞](#—Ñ–∞–∑–∞-7-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏-–∫–∞–∫-–ø—Ä–∞–≤–∏–ª–∞)
10. [–§–∞–∑–∞ 8: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–∏–∫–∏ —Å–±–æ—Ä–∞](#—Ñ–∞–∑–∞-8-—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥-–ª–æ–≥–∏–∫–∏-—Å–±–æ—Ä–∞)
11. [Checklist –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏](#checklist-–¥–ª—è-–ø—Ä–æ–≤–µ—Ä–∫–∏)
12. [–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏](#—Å–ª–µ–¥—É—é—â–∏–µ-—à–∞–≥–∏)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

FreshTrack —Å—Ç—Ä–∞–¥–∞–µ—Ç –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –µ–¥–∏–Ω–æ–π –º–æ–¥–µ–ª–∏ –≤–ª–∞–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏. –°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ, –∫—Ç–æ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –∏—Ö –≤–∏–¥–µ—Ç—å –∏ –∏–∑–º–µ–Ω—è—Ç—å, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–∞—Å—á—ë—Ç—ã —Å—Ç–∞—Ç—É—Å–æ–≤. –≠—Ç–æ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –≤—Å–µ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –±–∞–≥–∏ –∫–∞–∫ —Å–ª–µ–¥—Å—Ç–≤–∏–µ, –∞ –Ω–µ –∫–∞–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** backend –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã, –∞ frontend –¥—É–±–ª–∏—Ä—É–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

### 1. –ò–µ—Ä–∞—Ä—Ö–∏—è –≤–ª–∞–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏

–ö–∞–∂–¥–∞—è —Å—É—â–Ω–æ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–ª–∞–¥–µ–Ω–∏—è:

```
Organization (–Ω–µ—è–≤–Ω–æ, –æ–¥–∏–Ω –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã)
  ‚îî‚îÄ Hotel (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)
      ‚îî‚îÄ Department (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞ –æ—Ç–µ–ª—å)
          ‚îî‚îÄ User (–ø—Ä–∏–≤—è–∑–∞–Ω –∫ –æ–¥–Ω–æ–º—É –æ—Ç–µ–ª—é + –æ–¥–Ω–æ–º—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞–º)
              ‚îî‚îÄ –î–∞–Ω–Ω—ã–µ (–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, –ø–∞—Ä—Ç–∏–∏, –∏—Å—Ç–æ—Ä–∏—è, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
```

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ:**
- `backend/src/models/User.ts` –∏–º–µ–µ—Ç `hotelId`
- `backend/src/models/Department.ts` –∏–º–µ–µ—Ç `hotelId`
- –ù–û —Å–≤—è–∑–∏ User ‚Üí Department –Ω–µ—Ç
- `backend/src/models/Product.ts` –ù–ï –∏–º–µ–µ—Ç –Ω–∏ `hotelId`, –Ω–∏ `departmentId`
- `backend/src/models/Batch.ts` –∏–º–µ–µ—Ç `userId`, –Ω–æ –Ω–µ `departmentId`

**–†–µ—à–µ–Ω–∏–µ:**
–ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—è:
- `hotelId` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ, indexed)
- `departmentId` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, indexed)

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ —Å–≤–æ–∏–º –¥–∞–Ω–Ω—ã–º
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ "–¥—Ä—É–≥–æ–µ"

### 2. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ —Ä–æ–ª–µ–π

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
```typescript
// backend/src/middleware/auth.ts
export const requireRole = (roles: UserRole[]) => {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ if (roles.includes(user.role))
}
```

–≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç –ø–æ—á–µ–º—É HOTEL_ADMIN = SUPER_ADMIN –Ω–æ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç.

**–†–µ—à–µ–Ω–∏–µ:**
–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –æ–ø–∏—Å—ã–≤–∞—é—Ç **—á—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å**, –∞ –Ω–µ **–∫—Ç–æ —Ç—ã —Ç–∞–∫–æ–π**.

```
Permission = Resource + Action + Scope
  Resource: inventory | users | settings | reports | batches
  Action: read | create | update | delete | export
  Scope: own | department | hotel | all
```

**–ü—Ä–∏–º–µ—Ä—ã:**
- `inventory:read:department` - —á–∏—Ç–∞—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å —Å–≤–æ–µ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
- `users:create:hotel` - —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–º–∫–∞—Ö –æ—Ç–µ–ª—è
- `settings:update:all` - –º–µ–Ω—è—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–†–æ–ª–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–∞–±–æ—Ä–∞–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:**
- `SUPER_ADMIN`: –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–æ scope=all
- `HOTEL_ADMIN`: –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–æ scope=hotel (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Å–≤–æ–∏–º hotelId)
- `DEPARTMENT_MANAGER`: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–º, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π —Å–æ scope=department
- `USER`: —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –∏ –±–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ scope=own –∏–ª–∏ department (read-only)

### 3. Backend –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
–ò–∑—É—á–∞—è `frontend/src/`, –≤–∏–∂—É —á—Ç–æ —Å—Ç–∞—Ç—É—Å—ã —Å—Ä–æ–∫–æ–≤ –≥–æ–¥–Ω–æ—Å—Ç–∏, —Ü–≤–µ—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã, –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å, –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ.

**–†–µ—à–µ–Ω–∏–µ:**
Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –¥–∞–Ω–Ω—ã–µ, frontend —Ç–æ–ª—å–∫–æ —Ä–µ–Ω–¥–µ—Ä–∏—Ç.

–î–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞/–ø–∞—Ä—Ç–∏–∏ backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
```typescript
{
  id: string
  name: string
  expiryDate: string
  status: 'OK' | 'WARNING' | 'CRITICAL' | 'EXPIRED'
  daysUntilExpiry: number
  color: 'green' | 'yellow' | 'red' | 'gray'
  category: { id, name, color }
  department: { id, name }
  hotel: { id, name }
}
```

–î–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
```typescript
{
  byCategory: [{ categoryName, categoryColor, count, value }]
  byStatus: [{ status, count, percentage }]
  trends: [{ date, expired, warning, ok }]
  departmentId: string
  dateRange: { from, to }
}
```

### 4. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç–∞

–ï–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ middleware –∏–ª–∏ —Å–µ—Ä–≤–∏—Å:

–ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å:
- –ö—Ç–æ (userId)
- –ß—Ç–æ (action: create | update | delete | login | export)
- –ì–¥–µ (entityType: user | product | batch | settings)
- –ö–∞–∫–æ–π –æ–±—ä–µ–∫—Ç (entityId)
- –ü–æ–ª–Ω—ã–π snapshot –¥–∞–Ω–Ω—ã—Ö –î–û –∏ –ü–û–°–õ–ï
- –ö–æ–Ω—Ç–µ–∫—Å—Ç (hotelId, departmentId, IP, timestamp)

### 5. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**Notification Engine —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:**

**–ü—Ä–∞–≤–∏–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ):**
- –ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å WARNING (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7)
- –ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å CRITICAL (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
- –ö–∞–∫–∏–µ –∫–∞–Ω–∞–ª—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (app, telegram, email)
- –ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å (—Ä–æ–ª–∏, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)

**–î–≤–∏–∂–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- Background job –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä—Ç–∏–∏ –∫–∞–∂–¥—ã–π —á–∞—Å
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤–∏–ª
- –°–æ–∑–¥–∞—ë—Ç notification record –≤ –ë–î
- –°—Ç–∞–≤–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ –Ω—É–∂–Ω—ã–π –∫–∞–Ω–∞–ª
- –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (success/failure)
- Retry –ø—Ä–∏ –æ—à–∏–±–∫–µ (3 –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff)

### 6. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ (–±–ª–æ–∫–∏—Ä—É—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å):**
1. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–ª–∞–¥–µ–Ω–∏—è –¥–ª—è User

**–í–∞–∂–Ω—ã–µ (–≤–ª–∏—è—é—Ç –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö):**
1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–ª–∞–¥–µ–Ω–∏—è –¥–ª—è Product/Batch
2. Backend-–ª–æ–≥–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
3. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞—É–¥–∏—Ç

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ (–¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞):**
1. Notification Engine
2. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–∞

### 7. –≠—Ñ—Ñ–µ–∫—Ç –æ—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

**–ò—Å—á–µ–∑–Ω—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ ‚Üí backend –¥–∞—ë—Ç –≥–æ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–¥—Ä—É–≥–æ–µ" –≤–º–µ—Å—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí backend —Ä–µ–∑–æ–ª–≤–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ ID
- –ò—Å—Ç–æ—Ä–∏—è —Å–±–æ—Ä–æ–≤ "-" ‚Üí backend –±–µ—Ä—ë—Ç –∏–∑ snapshot
- HOTEL_ADMIN = SUPER_ADMIN ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ permissions —Å —É—á—ë—Ç–æ–º scope
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí permission check –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º
- Telegram –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ‚Üí —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ —Å retry

**–°—Ç–∞–Ω—É—Ç —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–º–∏:**
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ Department Manager ‚Üí –ø—Ä–æ—Å—Ç–æ –Ω–æ–≤—ã–π –Ω–∞–±–æ—Ä permissions
- –í—ã–±–æ—Ä –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
- –≠–∫—Å–ø–æ—Ä—Ç –≤–µ–∑–¥–µ ‚Üí –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è export —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚Üí –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ settings

---

## –§–∞–∑–∞ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

### –¶–µ–ª—å
–û–±–µ–∑–æ–ø–∞—Å–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞, —Å–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫–∏ –æ—Ç–∫–∞—Ç–∞, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

### –ó–∞–¥–∞—á–∏

#### 0.1 Backup –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
pg_dump freshtrack_db > backup_$(date +%Y%m%d).sql

# –°–æ–∑–¥–∞—Ç—å git tag —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
git tag -a v1.0-before-refactor -m "State before architecture refactor"
git push origin v1.0-before-refactor

# –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
git checkout -b refactor/architecture-v2
```

#### 0.2 –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `CURRENT_STATE.md`:
```markdown
# –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ FreshTrack

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- User: –∏–º–µ–µ—Ç hotelId, –ù–ï –∏–º–µ–µ—Ç departmentId
- Department: –∏–º–µ–µ—Ç hotelId
- Product: –ù–ï –∏–º–µ–µ—Ç hotelId, –ù–ï –∏–º–µ–µ—Ç departmentId
- Batch: –∏–º–µ–µ—Ç userId, –ù–ï –∏–º–µ–µ—Ç departmentId
- ActivityLog: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ–ø–æ–ª–Ω—ã–π

## –†–æ–ª–∏
- SUPER_ADMIN
- HOTEL_ADMIN (–ø—Ä–æ–±–ª–µ–º–∞: –ø—Ä–∞–≤–∞ = SUPER_ADMIN)
- USER

## –ö—Ä–∏—Ç–∏—á–Ω—ã–µ endpoints
- POST /api/users (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- POST /api/products (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞)
- POST /api/batches (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏)
- GET /api/inventory (—Å–ø–∏—Å–æ–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è)
- GET /api/statistics (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
```

#### 0.3 –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å production –ë–î –≤ test –ë–î
createdb freshtrack_test
pg_dump freshtrack_db | psql freshtrack_test

# –û–±–Ω–æ–≤–∏—Ç—å .env.test
DATABASE_URL=postgresql://user:pass@localhost:5432/freshtrack_test
NODE_ENV=test
```

#### 0.4 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –µ—Å–ª–∏ –Ω–µ—Ç
npm install --save-dev db-migrate db-migrate-pg

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –º–∏–≥—Ä–∞—Ü–∏–π
npx db-migrate init
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 0
- [ ] Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] Git tag —Å–æ–∑–¥–∞–Ω
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è –±–∞–∑–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞
- [ ] –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞

---

## –§–∞–∑–∞ 1: –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π

### –¶–µ–ª—å
–ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–æ–ª–µ–π –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (permissions). –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É HOTEL_ADMIN = SUPER_ADMIN.

### –ó–∞–¥–∞—á–∏

#### 1.1 –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Permission
–§–∞–π–ª: `backend/src/models/Permission.ts`
```typescript
import { DataTypes, Model } from 'sequelize';
import sequelize from '../config/database';

export enum PermissionResource {
  INVENTORY = 'inventory',
  PRODUCTS = 'products',
  BATCHES = 'batches',
  USERS = 'users',
  SETTINGS = 'settings',
  REPORTS = 'reports',
  DEPARTMENTS = 'departments',
  HOTELS = 'hotels'
}

export enum PermissionAction {
  READ = 'read',
  CREATE = 'create',
  UPDATE = 'update',
  DELETE = 'delete',
  EXPORT = 'export',
  MANAGE = 'manage'
}

export enum PermissionScope {
  OWN = 'own',           // –¢–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏
  DEPARTMENT = 'department', // –í —Ä–∞–º–∫–∞—Ö –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
  HOTEL = 'hotel',       // –í —Ä–∞–º–∫–∞—Ö –æ—Ç–µ–ª—è
  ALL = 'all'            // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
}

export interface PermissionAttributes {
  id: string;
  resource: PermissionResource;
  action: PermissionAction;
  scope: PermissionScope;
  description?: string;
}

class Permission extends Model<PermissionAttributes> implements PermissionAttributes {
  public id!: string;
  public resource!: PermissionResource;
  public action!: PermissionAction;
  public scope!: PermissionScope;
  public description?: string;
}

Permission.init(
  {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true,
    },
    resource: {
      type: DataTypes.ENUM(...Object.values(PermissionResource)),
      allowNull: false,
    },
    action: {
      type: DataTypes.ENUM(...Object.values(PermissionAction)),
      allowNull: false,
    },
    scope: {
      type: DataTypes.ENUM(...Object.values(PermissionScope)),
      allowNull: false,
    },
    description: {
      type: DataTypes.STRING,
      allowNull: true,
    },
  },
  {
    sequelize,
    tableName: 'permissions',
    indexes: [
      {
        unique: true,
        fields: ['resource', 'action', 'scope']
      }
    ]
  }
);

export default Permission;
```

#### 1.2 –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É RolePermission
–§–∞–π–ª: `backend/src/models/RolePermission.ts`
```typescript
import { DataTypes, Model } from 'sequelize';
import sequelize from '../config/database';
import { UserRole } from './User';

export interface RolePermissionAttributes {
  id: string;
  role: UserRole;
  permissionId: string;
}

class RolePermission extends Model<RolePermissionAttributes> implements RolePermissionAttributes {
  public id!: string;
  public role!: UserRole;
  public permissionId!: string;
}

RolePermission.init(
  {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true,
    },
    role: {
      type: DataTypes.ENUM('SUPER_ADMIN', 'HOTEL_ADMIN', 'DEPARTMENT_MANAGER', 'USER'),
      allowNull: false,
    },
    permissionId: {
      type: DataTypes.UUID,
      allowNull: false,
      references: {
        model: 'permissions',
        key: 'id',
      },
    },
  },
  {
    sequelize,
    tableName: 'role_permissions',
    indexes: [
      {
        unique: true,
        fields: ['role', 'permissionId']
      }
    ]
  }
);

export default RolePermission;
```

#### 1.3 –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
–§–∞–π–ª: `backend/src/services/permissionService.ts`
```typescript
import Permission, { PermissionResource, PermissionAction, PermissionScope } from '../models/Permission';
import RolePermission from '../models/RolePermission';
import User from '../models/User';

export interface PermissionCheckContext {
  user: User;
  targetHotelId?: string;
  targetDepartmentId?: string;
  targetUserId?: string;
}

export class PermissionService {
  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
   */
  static async hasPermission(
    context: PermissionCheckContext,
    resource: PermissionResource,
    action: PermissionAction
  ): Promise<boolean> {
    const { user, targetHotelId, targetDepartmentId, targetUserId } = context;

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ permissions –¥–ª—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const rolePermissions = await RolePermission.findAll({
      where: { role: user.role },
      include: [{ model: Permission }],
    });

    // –ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ permissions
    for (const rp of rolePermissions) {
      const permission = rp.permission;
      
      if (permission.resource !== resource || permission.action !== action) {
        continue;
      }

      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å scope
      const hasScope = await this.checkScope(user, permission.scope, {
        targetHotelId,
        targetDepartmentId,
        targetUserId,
      });

      if (hasScope) {
        return true;
      }
    }

    return false;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ scope
   */
  private static async checkScope(
    user: User,
    scope: PermissionScope,
    target: {
      targetHotelId?: string;
      targetDepartmentId?: string;
      targetUserId?: string;
    }
  ): Promise<boolean> {
    switch (scope) {
      case PermissionScope.ALL:
        return true;

      case PermissionScope.HOTEL:
        if (!target.targetHotelId) return true;
        return user.hotelId === target.targetHotelId;

      case PermissionScope.DEPARTMENT:
        if (!target.targetDepartmentId) return true;
        return user.departmentId === target.targetDepartmentId;

      case PermissionScope.OWN:
        if (!target.targetUserId) return true;
        return user.id === target.targetUserId;

      default:
        return false;
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø—Ä–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
   */
  static async canManageUser(actor: User, targetUser: User): Promise<boolean> {
    // –ù–µ–ª—å–∑—è —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–∞–º–∏–º —Å–æ–±–æ–π
    if (actor.id === targetUser.id) return false;

    // SUPER_ADMIN –º–æ–∂–µ—Ç –≤—Å–µ—Ö
    if (actor.role === 'SUPER_ADMIN') return true;

    // HOTEL_ADMIN –º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–≤–æ–µ–≥–æ –æ—Ç–µ–ª—è
    if (actor.role === 'HOTEL_ADMIN' && actor.hotelId === targetUser.hotelId) {
      // –ù–æ –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏–º–∏ HOTEL_ADMIN –∏–ª–∏ SUPER_ADMIN
      if (targetUser.role === 'HOTEL_ADMIN' || targetUser.role === 'SUPER_ADMIN') {
        return false;
      }
      return true;
    }

    return false;
  }
}
```

#### 1.4 –°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ permissions
–§–∞–π–ª: `backend/src/middleware/permission.ts`
```typescript
import { Request, Response, NextFunction } from 'express';
import { PermissionService } from '../services/permissionService';
import { PermissionResource, PermissionAction } from '../models/Permission';

export const requirePermission = (
  resource: PermissionResource,
  action: PermissionAction,
  options?: {
    getTargetHotelId?: (req: Request) => string | undefined;
    getTargetDepartmentId?: (req: Request) => string | undefined;
    getTargetUserId?: (req: Request) => string | undefined;
  }
) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      if (!req.user) {
        return res.status(401).json({ error: 'Authentication required' });
      }

      const context = {
        user: req.user,
        targetHotelId: options?.getTargetHotelId?.(req),
        targetDepartmentId: options?.getTargetDepartmentId?.(req),
        targetUserId: options?.getTargetUserId?.(req),
      };

      const hasPermission = await PermissionService.hasPermission(
        context,
        resource,
        action
      );

      if (!hasPermission) {
        return res.status(403).json({ 
          error: 'Forbidden',
          message: `You don't have permission to ${action} ${resource}` 
        });
      }

      next();
    } catch (error) {
      console.error('Permission check error:', error);
      res.status(500).json({ error: 'Internal server error' });
    }
  };
};
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 1
- [ ] –ú–æ–¥–µ–ª–∏ Permission –∏ RolePermission —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] Seed –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω
- [ ] PermissionService —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Middleware requirePermission —Å–æ–∑–¥–∞–Ω
- [ ] –ú–∏–Ω–∏–º—É–º 3 —Ä–æ—É—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å –Ω–æ–≤—ã–º middleware
- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤—Ä—É—á–Ω—É—é)

---

## –§–∞–∑–∞ 2: –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–ª–∞–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏

### –¶–µ–ª—å
–î–æ–±–∞–≤–∏—Ç—å `hotelId` –∏ `departmentId` –∫–æ –≤—Å–µ–º —Å—É—â–Ω–æ—Å—Ç—è–º. –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π, –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏.

### –ó–∞–¥–∞—á–∏

#### 2.1 –î–æ–±–∞–≤–∏—Ç—å departmentId –≤ User
–§–∞–π–ª: `backend/migrations/20240101000002-add-department-to-user.js`
```javascript
'use strict';

module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.addColumn('users', 'departmentId', {
      type: Sequelize.UUID,
      allowNull: true,
      references: {
        model: 'departments',
        key: 'id',
      },
    });

    await queryInterface.addIndex('users', ['departmentId']);

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    await queryInterface.sequelize.query(`
      UPDATE users u
      SET "departmentId" = (
        SELECT id FROM departments d
        WHERE d."hotelId" = u."hotelId"
        LIMIT 1
      )
      WHERE u."departmentId" IS NULL
    `);

    await queryInterface.changeColumn('users', 'departmentId', {
      type: Sequelize.UUID,
      allowNull: false,
    });
  },

  down: async (queryInterface) => {
    await queryInterface.removeColumn('users', 'departmentId');
  }
};
```

#### 2.2 –î–æ–±–∞–≤–∏—Ç—å hotelId –∏ departmentId –≤ Product
–§–∞–π–ª: `backend/migrations/20240101000003-add-context-to-product.js`
```javascript
'use strict';

module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.addColumn('products', 'hotelId', {
      type: Sequelize.UUID,
      allowNull: true,
      references: { model: 'hotels', key: 'id' },
    });

    await queryInterface.addColumn('products', 'departmentId', {
      type: Sequelize.UUID,
      allowNull: true,
      references: { model: 'departments', key: 'id' },
    });

    await queryInterface.addIndex('products', ['hotelId']);
    await queryInterface.addIndex('products', ['departmentId']);

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–º–∏
    await queryInterface.sequelize.query(`
      UPDATE products p
      SET 
        "hotelId" = (SELECT "hotelId" FROM users LIMIT 1),
        "departmentId" = (SELECT "departmentId" FROM users LIMIT 1)
      WHERE p."hotelId" IS NULL
    `);

    await queryInterface.changeColumn('products', 'hotelId', {
      type: Sequelize.UUID,
      allowNull: false,
    });

    await queryInterface.changeColumn('products', 'departmentId', {
      type: Sequelize.UUID,
      allowNull: false,
    });
  },

  down: async (queryInterface) => {
    await queryInterface.removeColumn('products', 'departmentId');
    await queryInterface.removeColumn('products', 'hotelId');
  }
};
```

#### 2.3 –î–æ–±–∞–≤–∏—Ç—å hotelId –∏ departmentId –≤ Batch
```javascript
'use strict';

module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.addColumn('batches', 'hotelId', {
      type: Sequelize.UUID,
      allowNull: true,
      references: { model: 'hotels', key: 'id' },
    });

    await queryInterface.addColumn('batches', 'departmentId', {
      type: Sequelize.UUID,
      allowNull: true,
      references: { model: 'departments', key: 'id' },
    });

    await queryInterface.addIndex('batches', ['hotelId']);
    await queryInterface.addIndex('batches', ['departmentId']);

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await queryInterface.sequelize.query(`
      UPDATE batches b
      SET 
        "hotelId" = u."hotelId",
        "departmentId" = u."departmentId"
      FROM users u
      WHERE b."userId" = u.id
        AND b."hotelId" IS NULL
    `);

    await queryInterface.changeColumn('batches', 'hotelId', {
      type: Sequelize.UUID,
      allowNull: false,
    });

    await queryInterface.changeColumn('batches', 'departmentId', {
      type: Sequelize.UUID,
      allowNull: false,
    });
  },

  down: async (queryInterface) => {
    await queryInterface.removeColumn('batches', 'departmentId');
    await queryInterface.removeColumn('batches', 'hotelId');
  }
};
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 2
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è User, Product, Batch, Category –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ú–æ–¥–µ–ª–∏ Sequelize –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## –§–∞–∑–∞ 3: Backend –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –ª–æ–≥–∏–∫–∏

### –¶–µ–ª—å
–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –Ω–∞ backend. Frontend —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ.

### –ó–∞–¥–∞—á–∏

#### 3.1 –°–æ–∑–¥–∞—Ç—å StatusService
–§–∞–π–ª: `backend/src/services/statusService.ts`
```typescript
export enum ExpiryStatus {
  EXPIRED = 'EXPIRED',
  CRITICAL = 'CRITICAL',
  WARNING = 'WARNING',
  OK = 'OK'
}

export interface StatusColors {
  bg: string;
  text: string;
  border: string;
}

export class StatusService {
  private static warningDays = 7;
  private static criticalDays = 3;

  static calculateStatus(expiryDate: Date): ExpiryStatus {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const expiry = new Date(expiryDate);
    expiry.setHours(0, 0, 0, 0);
    
    const diffTime = expiry.getTime() - today.getTime();
    const daysUntilExpiry = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (daysUntilExpiry < 0) return ExpiryStatus.EXPIRED;
    if (daysUntilExpiry <= this.criticalDays) return ExpiryStatus.CRITICAL;
    if (daysUntilExpiry <= this.warningDays) return ExpiryStatus.WARNING;
    return ExpiryStatus.OK;
  }

  static getColors(status: ExpiryStatus): StatusColors {
    switch (status) {
      case ExpiryStatus.EXPIRED:
        return { bg: '#FEE2E2', text: '#DC2626', border: '#DC2626' };
      case ExpiryStatus.CRITICAL:
        return { bg: '#FEF3C7', text: '#D97706', border: '#D97706' };
      case ExpiryStatus.WARNING:
        return { bg: '#FEF9C3', text: '#CA8A04', border: '#CA8A04' };
      case ExpiryStatus.OK:
        return { bg: '#DCFCE7', text: '#16A34A', border: '#16A34A' };
    }
  }

  static getDaysUntilExpiry(expiryDate: Date): number {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const expiry = new Date(expiryDate);
    expiry.setHours(0, 0, 0, 0);
    const diffTime = expiry.getTime() - today.getTime();
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  }
}
```

#### 3.2 –û–±–Ω–æ–≤–∏—Ç—å API responses
```typescript
// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ batches
export async function getBatches(req: Request, res: Response) {
  const batches = await Batch.findAll({
    where: { departmentId: req.user.departmentId },
    include: [{ model: Product, include: [Category] }]
  });

  const enrichedBatches = batches.map(batch => {
    const status = StatusService.calculateStatus(batch.expiryDate);
    const colors = StatusService.getColors(status);
    const daysUntilExpiry = StatusService.getDaysUntilExpiry(batch.expiryDate);

    return {
      ...batch.toJSON(),
      status,
      daysUntilExpiry,
      colors,
      category: batch.product?.category ? {
        id: batch.product.category.id,
        name: batch.product.category.name,
        color: batch.product.category.color
      } : null
    };
  });

  res.json({ batches: enrichedBatches });
}
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 3
- [ ] StatusService —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] –í—Å–µ API endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç enriched –¥–∞–Ω–Ω—ã–µ
- [ ] Frontend —É–±—Ä–∞–Ω —Ä–∞—Å—á—ë—Ç —Å—Ç–∞—Ç—É—Å–æ–≤
- [ ] –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º" —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –§–∞–∑–∞ 4: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞—É–¥–∏—Ç

### –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ.

### –ó–∞–¥–∞—á–∏

#### 4.1 –†–∞—Å—à–∏—Ä–∏—Ç—å –º–æ–¥–µ–ª—å ActivityLog
```typescript
export enum ActivityAction {
  CREATE = 'create',
  UPDATE = 'update',
  DELETE = 'delete',
  LOGIN = 'login',
  LOGOUT = 'logout',
  EXPORT = 'export',
  BLOCK = 'block',
  UNBLOCK = 'unblock',
  COLLECT = 'collect'
}

export enum ActivityEntityType {
  USER = 'user',
  PRODUCT = 'product',
  BATCH = 'batch',
  CATEGORY = 'category',
  DEPARTMENT = 'department',
  HOTEL = 'hotel',
  SETTINGS = 'settings',
  COLLECTION = 'collection'
}

export interface ActivityLogAttributes {
  id: string;
  userId: string;
  action: ActivityAction;
  entityType: ActivityEntityType;
  entityId: string;
  entityName?: string;
  snapshotBefore?: object;
  snapshotAfter?: object;
  metadata?: object;
  hotelId: string;
  departmentId?: string;
  ipAddress?: string;
  userAgent?: string;
  createdAt: Date;
}
```

#### 4.2 –°–æ–∑–¥–∞—Ç—å AuditService
```typescript
export class AuditService {
  static async log(params: {
    user: User;
    action: ActivityAction;
    entityType: ActivityEntityType;
    entityId: string;
    entityName?: string;
    snapshotBefore?: object;
    snapshotAfter?: object;
    metadata?: object;
    request?: Request;
  }) {
    const { user, action, entityType, entityId, entityName, 
            snapshotBefore, snapshotAfter, metadata, request } = params;

    await ActivityLog.create({
      userId: user.id,
      action,
      entityType,
      entityId,
      entityName,
      snapshotBefore,
      snapshotAfter,
      metadata,
      hotelId: user.hotelId,
      departmentId: user.departmentId,
      ipAddress: request?.ip,
      userAgent: request?.get('User-Agent'),
    });
  }

  static formatDescription(log: ActivityLog): string {
    const actionTexts = {
      create: '—Å–æ–∑–¥–∞–ª',
      update: '–æ–±–Ω–æ–≤–∏–ª',
      delete: '—É–¥–∞–ª–∏–ª',
      login: '–≤–æ—à—ë–ª –≤ —Å–∏—Å—Ç–µ–º—É',
      logout: '–≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã',
      export: '—ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª',
      block: '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª',
      unblock: '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª',
      collect: '—Å–ø–∏—Å–∞–ª'
    };

    const entityTexts = {
      user: '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      product: '—Ç–æ–≤–∞—Ä',
      batch: '–ø–∞—Ä—Ç–∏—é',
      category: '–∫–∞—Ç–µ–≥–æ—Ä–∏—é',
      department: '–æ—Ç–¥–µ–ª',
      hotel: '–æ—Ç–µ–ª—å',
      settings: '–Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
      collection: '—Å–ø–∏—Å–∞–Ω–∏–µ'
    };

    const action = actionTexts[log.action] || log.action;
    const entity = entityTexts[log.entityType] || log.entityType;
    const name = log.entityName ? `"${log.entityName}"` : '';

    return `${action} ${entity} ${name}`.trim();
  }
}
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 4
- [ ] ActivityLog –º–æ–¥–µ–ª—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∞
- [ ] AuditService —Å–æ–∑–¥–∞–Ω
- [ ] –í—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –ª–æ–≥–∏—Ä—É—é—Ç –¥–µ–π—Å—Ç–≤–∏—è
- [ ] –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª–Ω–∞—è –∏ —á–∏—Ç–∞–µ–º–∞—è
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –§–∞–∑–∞ 5: Notification Engine

### –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –Ω–∞–¥—ë–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å retry –∏ –∏—Å—Ç–æ—Ä–∏–µ–π.

### –ó–∞–¥–∞—á–∏

#### 5.1 –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Notification
```typescript
export enum NotificationChannel {
  APP = 'app',
  TELEGRAM = 'telegram',
  EMAIL = 'email'
}

export enum NotificationStatus {
  PENDING = 'pending',
  SENT = 'sent',
  FAILED = 'failed',
  READ = 'read'
}

export interface NotificationAttributes {
  id: string;
  userId: string;
  channel: NotificationChannel;
  type: string;
  title: string;
  message: string;
  data?: object;
  status: NotificationStatus;
  attempts: number;
  lastAttemptAt?: Date;
  sentAt?: Date;
  readAt?: Date;
  hotelId: string;
  departmentId?: string;
  createdAt: Date;
}
```

#### 5.2 –°–æ–∑–¥–∞—Ç—å NotificationService
```typescript
export class NotificationService {
  private static maxRetries = 3;

  static async send(params: {
    userId: string;
    channel: NotificationChannel;
    type: string;
    title: string;
    message: string;
    data?: object;
  }) {
    const notification = await Notification.create({
      ...params,
      status: NotificationStatus.PENDING,
      attempts: 0,
    });

    await this.deliver(notification);
    return notification;
  }

  private static async deliver(notification: Notification) {
    try {
      notification.attempts++;
      notification.lastAttemptAt = new Date();

      switch (notification.channel) {
        case NotificationChannel.TELEGRAM:
          await TelegramService.send(notification);
          break;
        case NotificationChannel.EMAIL:
          await EmailService.send(notification);
          break;
        case NotificationChannel.APP:
          // App notifications are stored in DB only
          break;
      }

      notification.status = NotificationStatus.SENT;
      notification.sentAt = new Date();
    } catch (error) {
      console.error('Notification delivery failed:', error);
      
      if (notification.attempts >= this.maxRetries) {
        notification.status = NotificationStatus.FAILED;
      }
    }

    await notification.save();
  }
}
```

#### 5.3 –°–æ–∑–¥–∞—Ç—å ExpiryCheckJob
```typescript
export class ExpiryCheckJob {
  static async run() {
    console.log('Running expiry check job...');

    const settings = await SettingsService.get('notifications.warningDays');
    const warningDays = settings?.value || 7;

    const criticalSettings = await SettingsService.get('notifications.criticalDays');
    const criticalDays = criticalSettings?.value || 3;

    // –ù–∞–π—Ç–∏ –ø–∞—Ä—Ç–∏–∏ —Ç—Ä–µ–±—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const batchesNeedingAlert = await Batch.findAll({
      where: {
        expiryDate: {
          [Op.lte]: new Date(Date.now() + warningDays * 24 * 60 * 60 * 1000)
        },
        quantity: { [Op.gt]: 0 }
      },
      include: [Product, { model: User, as: 'department' }]
    });

    for (const batch of batchesNeedingAlert) {
      const status = StatusService.calculateStatus(batch.expiryDate);
      const daysLeft = StatusService.getDaysUntilExpiry(batch.expiryDate);

      // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
      const recipients = await this.getRecipients(batch);

      for (const user of recipients) {
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ
        const existing = await Notification.findOne({
          where: {
            userId: user.id,
            type: 'expiry_warning',
            'data.batchId': batch.id,
            createdAt: { [Op.gte]: new Date(Date.now() - 24 * 60 * 60 * 1000) }
          }
        });

        if (existing) continue;

        await NotificationService.send({
          userId: user.id,
          channel: user.preferredChannel || NotificationChannel.APP,
          type: 'expiry_warning',
          title: status === ExpiryStatus.CRITICAL ? '‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω—ã–π —Å—Ä–æ–∫!' : 'üìÖ –°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏',
          message: `${batch.product.name}: ${daysLeft} –¥–Ω. –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è`,
          data: { batchId: batch.id, productId: batch.productId, daysLeft, status }
        });
      }
    }
  }

  private static async getRecipients(batch: Batch): Promise<User[]> {
    return User.findAll({
      where: {
        departmentId: batch.departmentId,
        isBlocked: false
      }
    });
  }
}
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 5
- [ ] Notification –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞
- [ ] NotificationService —Å retry —Å–æ–∑–¥–∞–Ω
- [ ] ExpiryCheckJob —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
- [ ] Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è
- [ ] –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

---

## –§–∞–∑–∞ 6: –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤.

### –ó–∞–¥–∞—á–∏

#### 6.1 –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∏–ø—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
```typescript
export interface StandardFilters {
  hotelId?: string;
  departmentIds?: string[];
  dateFrom?: Date;
  dateTo?: Date;
  status?: ExpiryStatus[];
  categoryIds?: string[];
  search?: string;
  limit?: number;
  offset?: number;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}

export interface StandardResponse<T> {
  data: T[];
  pagination: {
    total: number;
    page: number;
    pageSize: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
  filters: {
    applied: Partial<StandardFilters>;
    available: {
      categories: { id: string; name: string }[];
      departments: { id: string; name: string }[];
      statuses: ExpiryStatus[];
    };
  };
  summary?: {
    totalQuantity?: number;
    byStatus?: Record<ExpiryStatus, number>;
  };
}
```

#### 6.2 –°–æ–∑–¥–∞—Ç—å QueryBuilder
```typescript
export class QueryBuilder {
  static buildWhereClause(filters: StandardFilters, user: User) {
    const where: any = {};

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (user.role !== 'SUPER_ADMIN') {
      where.hotelId = user.hotelId;
    }

    if (user.role === 'USER' || user.role === 'DEPARTMENT_MANAGER') {
      where.departmentId = user.departmentId;
    }

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —è–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    if (filters.departmentIds?.length) {
      where.departmentId = { [Op.in]: filters.departmentIds };
    }

    if (filters.categoryIds?.length) {
      where.categoryId = { [Op.in]: filters.categoryIds };
    }

    if (filters.dateFrom || filters.dateTo) {
      where.expiryDate = {};
      if (filters.dateFrom) where.expiryDate[Op.gte] = filters.dateFrom;
      if (filters.dateTo) where.expiryDate[Op.lte] = filters.dateTo;
    }

    if (filters.search) {
      where.name = { [Op.iLike]: `%${filters.search}%` };
    }

    return where;
  }

  static buildPagination(filters: StandardFilters) {
    return {
      limit: filters.limit || 50,
      offset: filters.offset || 0,
      order: [[filters.sortBy || 'createdAt', filters.sortOrder || 'desc']]
    };
  }
}
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 6
- [ ] StandardFilters –∏ StandardResponse —Ç–∏–ø—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] QueryBuilder —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] –í—Å–µ API –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- [ ] –§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –§–∞–∑–∞ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–∞

### –¶–µ–ª—å
–°–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª —Å–∏—Å—Ç–µ–º—ã.

### –ó–∞–¥–∞—á–∏

#### 7.1 –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Settings
```typescript
export enum SettingsScope {
  SYSTEM = 'system',
  HOTEL = 'hotel',
  DEPARTMENT = 'department',
  USER = 'user'
}

export interface SettingsAttributes {
  id: string;
  scope: SettingsScope;
  scopeId?: string;
  key: string;
  value: any;
  description?: string;
}
```

#### 7.2 –°–æ–∑–¥–∞—Ç—å SettingsService —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π
```typescript
export class SettingsService {
  /**
   * –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å —É—á—ë—Ç–æ–º –∏–µ—Ä–∞—Ä—Ö–∏–∏
   * User ‚Üí Department ‚Üí Hotel ‚Üí System
   */
  static async get(key: string, user?: User): Promise<any> {
    if (user) {
      // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å user-level
      const userSetting = await Settings.findOne({
        where: { key, scope: SettingsScope.USER, scopeId: user.id }
      });
      if (userSetting) return userSetting.value;

      // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å department-level
      const deptSetting = await Settings.findOne({
        where: { key, scope: SettingsScope.DEPARTMENT, scopeId: user.departmentId }
      });
      if (deptSetting) return deptSetting.value;

      // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å hotel-level
      const hotelSetting = await Settings.findOne({
        where: { key, scope: SettingsScope.HOTEL, scopeId: user.hotelId }
      });
      if (hotelSetting) return hotelSetting.value;
    }

    // System-level (default)
    const systemSetting = await Settings.findOne({
      where: { key, scope: SettingsScope.SYSTEM }
    });
    return systemSetting?.value;
  }

  static async set(key: string, value: any, scope: SettingsScope, scopeId?: string) {
    const [setting] = await Settings.upsert({
      key,
      value,
      scope,
      scopeId
    });
    return setting;
  }
}
```

#### 7.3 Seed –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
```typescript
const defaultSettings = [
  { scope: SettingsScope.SYSTEM, key: 'branding.logo', value: '/assets/logo.png' },
  { scope: SettingsScope.SYSTEM, key: 'branding.primaryColor', value: '#3B82F6' },
  { scope: SettingsScope.SYSTEM, key: 'branding.secondaryColor', value: '#10B981' },
  { scope: SettingsScope.SYSTEM, key: 'branding.companyName', value: 'FreshTrack' },
  { scope: SettingsScope.SYSTEM, key: 'locale.language', value: 'en' },
  { scope: SettingsScope.SYSTEM, key: 'locale.timezone', value: 'UTC' },
  { scope: SettingsScope.SYSTEM, key: 'locale.dateFormat', value: 'MM/DD/YYYY' },
  { scope: SettingsScope.SYSTEM, key: 'notifications.warningDays', value: 7 },
  { scope: SettingsScope.SYSTEM, key: 'notifications.criticalDays', value: 3 },
];
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 7
- [ ] Settings –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞
- [ ] SettingsService —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π
- [ ] API –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–æ–∑–¥–∞–Ω–æ
- [ ] Seed –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ë—Ä–µ–Ω–¥–∏–Ω–≥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –§–∞–∑–∞ 8: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–∏–∫–∏ —Å–±–æ—Ä–∞

### –ü—Ä–æ–±–ª–µ–º–∞
–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç **–ø–æ –ø–∞—Ä—Ç–∏—è–º (batches)** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Ü–µ–ª—É—é –ø–∞—Ä—Ç–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞ –∑–∞ —Ä–∞–∑. –í —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö –æ—Ç–µ–ª—è —Å 160 –º–∏–Ω–∏-–±–∞—Ä–∞–º–∏ —ç—Ç–æ –Ω–µ–ø—Ä–∏–º–µ–Ω–∏–º–æ:

- –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–∏–Ω–∏-–±–∞—Ä–æ–≤
- –û–Ω –Ω–µ –∑–Ω–∞–µ—Ç –∏–∑ –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –ø–∞—Ä—Ç–∏–∏ –≤–∑—è—Ç –∫–∞–∂–¥—ã–π –ø—Ä–æ–¥—É–∫—Ç
- –ï–º—É –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∑–∞—Ç—å: "–°–æ–±—Ä–∞–ª 15 —à—Ç—É–∫ Coca-Cola"

### –†–µ—à–µ–Ω–∏–µ: –°–±–æ—Ä –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å FIFO

#### –ù–æ–≤—ã–π flow –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
2. –í–∏–¥–∏—Ç:
   - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ (—Å—É–º–º–∞ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏–π)
   - –†–∞–∑–±–∏–≤–∫—É –ø–æ –ø–∞—Ä—Ç–∏—è–º —Å –¥–∞—Ç–∞–º–∏ (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
   - –ë–ª–∏–∂–∞–π—à–∏–π —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏
3. –í–≤–æ–¥–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 15)
4. –í—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É —Å–ø–∏—Å–∞–Ω–∏—è:
   - collected (—Å–æ–±—Ä–∞–Ω–æ/–ø—Ä–æ–¥–∞–Ω–æ)
   - expired (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ)
   - damaged (–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–æ)
   - other (–¥—Ä—É–≥–æ–µ)
5. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
6. –ù–∞–∂–∏–º–∞–µ—Ç "–°–ø–∏—Å–∞—Ç—å"
7. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç FIFO:
   - –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–∞—Ä—Ç–∏–∏ –ø–æ expiry_date (ASC)
   - –°–ø–∏—Å—ã–≤–∞–µ—Ç –∏–∑ –ø–∞—Ä—Ç–∏–π —Å –±–ª–∏–∂–∞–π—à–∏–º —Å—Ä–æ–∫–æ–º
   - –ï—Å–ª–∏ –æ–¥–Ω–æ–π –ø–∞—Ä—Ç–∏–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –±–µ—Ä—ë—Ç –∏–∑ —Å–ª–µ–¥—É—é—â–µ–π
   - –ü–∞—Ä—Ç–∏–∏ —Å quantity=0 —É–¥–∞–ª—è—é—Ç—Å—è
```

#### –ü—Ä–∏–º–µ—Ä FIFO –∞–ª–≥–æ—Ä–∏—Ç–º–∞:
```
Coca-Cola –Ω–∞ —Å–∫–ª–∞–¥–µ:
‚îú‚îÄ Batch #1: exp 25.12.2025 ‚Äî 50 —à—Ç
‚îú‚îÄ Batch #2: exp 28.12.2025 ‚Äî 30 —à—Ç
‚îî‚îÄ Batch #3: exp 05.01.2026 ‚Äî 20 —à—Ç
–í—Å–µ–≥–æ: 100 —à—Ç

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø–∏—Å—ã–≤–∞–µ—Ç: 65 —à—Ç

–†–µ–∑—É–ª—å—Ç–∞—Ç:
‚îú‚îÄ Batch #1: 50 ‚Üí 0 —à—Ç (—Å–ø–∏—Å–∞–Ω–æ 50) ‚Üí DELETE
‚îú‚îÄ Batch #2: 30 ‚Üí 15 —à—Ç (—Å–ø–∏—Å–∞–Ω–æ 15)
‚îî‚îÄ Batch #3: –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ó–∞–ø–∏—Å–∏ –≤ collections:
‚îú‚îÄ { batchId: 1, quantity: 50, reason: 'collected' }
‚îî‚îÄ { batchId: 2, quantity: 15, reason: 'collected' }
```

### –ó–∞–¥–∞—á–∏

#### 8.1 –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å Collection
–§–∞–π–ª: `backend/src/models/Collection.ts`
```typescript
export interface CollectionAttributes {
  id: string;
  productId: string;
  batchId: string | null;
  quantity: number;
  reason: 'collected' | 'expired' | 'damaged' | 'other';
  notes: string | null;
  collectedBy: string;
  departmentId: string;
  hotelId: string;
  batchSnapshot: {
    expiryDate: string;
    productionDate: string | null;
    originalQuantity: number;
  } | null;
  createdAt: Date;
}
```

#### 8.2 –°–æ–∑–¥–∞—Ç—å CollectionService —Å FIFO
–§–∞–π–ª: `backend/src/services/CollectionService.ts`
```typescript
import { Transaction, Op } from 'sequelize';
import { sequelize } from '../config/database';
import { Collection } from '../models/Collection';
import { Batch } from '../models/Batch';
import { AuditService } from './auditService';

export interface CollectRequest {
  productId: string;
  quantity: number;
  reason: 'collected' | 'expired' | 'damaged' | 'other';
  notes?: string;
  departmentId: string;
}

export interface CollectResult {
  success: boolean;
  totalCollected: number;
  batchesAffected: Array<{
    batchId: string;
    collected: number;
    remaining: number;
    deleted: boolean;
    expiryDate: string;
  }>;
  collections: Collection[];
  error?: string;
}

export class CollectionService {
  /**
   * –°–ø–∏—Å–∞—Ç—å —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—è FIFO
   */
  async collectProduct(
    request: CollectRequest,
    userId: string,
    hotelId: string
  ): Promise<CollectResult> {
    const { productId, quantity, reason, notes, departmentId } = request;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (quantity <= 0) {
      return {
        success: false,
        totalCollected: 0,
        batchesAffected: [],
        collections: [],
        error: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0',
      };
    }

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–∞—Ä—Ç–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ —Å—Ä–æ–∫—É –≥–æ–¥–Ω–æ—Å—Ç–∏ (FIFO)
    const batches = await Batch.findAll({
      where: {
        productId,
        hotelId,
        quantity: { [Op.gt]: 0 },
      },
      order: [['expiryDate', 'ASC']],
    });

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    const totalAvailable = batches.reduce((sum, b) => sum + b.quantity, 0);
    if (totalAvailable < quantity) {
      return {
        success: false,
        totalCollected: 0,
        batchesAffected: [],
        collections: [],
        error: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞. –î–æ—Å—Ç—É–ø–Ω–æ: ${totalAvailable}, –∑–∞–ø—Ä–æ—à–µ–Ω–æ: ${quantity}`,
      };
    }

    // –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    const result = await sequelize.transaction(async (transaction: Transaction) => {
      let remainingToCollect = quantity;
      const batchesAffected: CollectResult['batchesAffected'] = [];
      const collections: Collection[] = [];

      for (const batch of batches) {
        if (remainingToCollect <= 0) break;

        const toCollectFromBatch = Math.min(batch.quantity, remainingToCollect);
        const newQuantity = batch.quantity - toCollectFromBatch;
        const shouldDelete = newQuantity === 0;

        // –°–æ–∑–¥–∞—Ç—å snapshot –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
        const batchSnapshot = {
          expiryDate: batch.expiryDate.toISOString(),
          productionDate: batch.productionDate?.toISOString() || null,
          originalQuantity: batch.quantity,
        };

        // –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –æ —Å–ø–∏—Å–∞–Ω–∏–∏
        const collection = await Collection.create({
          productId,
          batchId: batch.id,
          quantity: toCollectFromBatch,
          reason,
          notes,
          collectedBy: userId,
          departmentId,
          hotelId,
          batchSnapshot,
        }, { transaction });

        collections.push(collection);

        // –û–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–∞—Ä—Ç–∏—é
        if (shouldDelete) {
          await batch.destroy({ transaction });
        } else {
          batch.quantity = newQuantity;
          await batch.save({ transaction });
        }

        batchesAffected.push({
          batchId: batch.id,
          collected: toCollectFromBatch,
          remaining: newQuantity,
          deleted: shouldDelete,
          expiryDate: batch.expiryDate.toISOString(),
        });

        remainingToCollect -= toCollectFromBatch;
      }

      return { batchesAffected, collections };
    });

    return {
      success: true,
      totalCollected: quantity,
      ...result,
    };
  }

  /**
   * –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä FIFO —Å–ø–∏—Å–∞–Ω–∏—è (–±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
   */
  async previewCollection(
    productId: string,
    quantity: number,
    hotelId: string
  ): Promise<Array<{ batchId: string; expiryDate: string; toCollect: number; remaining: number }>> {
    const batches = await Batch.findAll({
      where: {
        productId,
        hotelId,
        quantity: { [Op.gt]: 0 },
      },
      order: [['expiryDate', 'ASC']],
    });

    let remainingToCollect = quantity;
    const preview = [];

    for (const batch of batches) {
      if (remainingToCollect <= 0) break;

      const toCollect = Math.min(batch.quantity, remainingToCollect);
      preview.push({
        batchId: batch.id,
        expiryDate: batch.expiryDate.toISOString(),
        toCollect,
        remaining: batch.quantity - toCollect,
      });

      remainingToCollect -= toCollect;
    }

    return preview;
  }
}
```

#### 8.3 –°–æ–∑–¥–∞—Ç—å API endpoint
–§–∞–π–ª: `backend/src/routes/collections.ts`
```typescript
import express from 'express';
import { requireAuth } from '../middleware/auth';
import { requirePermission } from '../middleware/permission';
import { PermissionResource, PermissionAction } from '../models/Permission';
import { CollectionService } from '../services/CollectionService';
import { AuditService } from '../services/auditService';
import { ActivityAction, ActivityEntityType } from '../models/ActivityLog';

const router = express.Router();
const collectionService = new CollectionService();

// POST /api/collections/collect - –°–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
router.post(
  '/collect',
  requireAuth,
  requirePermission(PermissionResource.BATCHES, PermissionAction.UPDATE),
  async (req, res) => {
    try {
      const { productId, quantity, reason, notes } = req.body;
      const user = req.user;

      const result = await collectionService.collectProduct(
        {
          productId,
          quantity,
          reason,
          notes,
          departmentId: user.departmentId,
        },
        user.id,
        user.hotelId
      );

      if (!result.success) {
        return res.status(400).json({ error: result.error });
      }

      // –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
      await AuditService.log({
        user,
        action: ActivityAction.COLLECT,
        entityType: ActivityEntityType.COLLECTION,
        entityId: result.collections[0]?.id || 'bulk',
        entityName: `–°–ø–∏—Å–∞–Ω–∏–µ ${quantity} —à—Ç`,
        snapshotAfter: {
          productId,
          quantity,
          reason,
          batchesAffected: result.batchesAffected,
        },
        request: req,
      });

      res.json(result);
    } catch (error) {
      console.error('Collection error:', error);
      res.status(500).json({ error: 'Failed to collect product' });
    }
  }
);

// GET /api/collections/preview - –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä FIFO —Å–ø–∏—Å–∞–Ω–∏—è
router.get(
  '/preview',
  requireAuth,
  async (req, res) => {
    try {
      const { productId, quantity } = req.query;
      const user = req.user;

      const preview = await collectionService.previewCollection(
        productId as string,
        parseInt(quantity as string),
        user.hotelId
      );

      res.json({ preview });
    } catch (error) {
      console.error('Preview error:', error);
      res.status(500).json({ error: 'Failed to generate preview' });
    }
  }
);

export default router;
```

#### 8.4 –°–æ–∑–¥–∞—Ç—å frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
–§–∞–π–ª: `frontend/src/components/CollectProductModal.tsx`
```typescript
import React, { useState, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { Minus, Plus, AlertTriangle } from 'lucide-react';

interface Batch {
  id: string;
  expiryDate: string;
  quantity: number;
  status: string;
  daysUntilExpiry: number;
}

interface CollectProductModalProps {
  product: {
    id: string;
    name: string;
    totalQuantity: number;
    batches: Batch[];
  };
  isOpen: boolean;
  onClose: () => void;
  onCollect: (data: { quantity: number; reason: string; notes?: string }) => Promise<void>;
}

const REASONS = [
  { value: 'collected', labelKey: 'collection.reasons.collected' },
  { value: 'expired', labelKey: 'collection.reasons.expired' },
  { value: 'damaged', labelKey: 'collection.reasons.damaged' },
  { value: 'other', labelKey: 'collection.reasons.other' },
];

export function CollectProductModal({ product, isOpen, onClose, onCollect }: CollectProductModalProps) {
  const { t } = useTranslation();
  const [quantity, setQuantity] = useState(1);
  const [reason, setReason] = useState('collected');
  const [notes, setNotes] = useState('');
  const [preview, setPreview] = useState<Array<{ batchId: string; toCollect: number }>>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å preview –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
  useEffect(() => {
    if (quantity > 0 && quantity <= product.totalQuantity) {
      fetchPreview();
    }
  }, [quantity, product.id]);

  const fetchPreview = async () => {
    try {
      const res = await fetch(`/api/collections/preview?productId=${product.id}&quantity=${quantity}`);
      const data = await res.json();
      setPreview(data.preview);
    } catch (err) {
      console.error('Preview fetch error:', err);
    }
  };

  const handleSubmit = async () => {
    if (quantity <= 0 || quantity > product.totalQuantity) {
      setError(t('collection.error.invalid_quantity'));
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      await onCollect({ quantity, reason, notes: notes || undefined });
      onClose();
    } catch (err: any) {
      setError(err.message || t('collection.error.general'));
    } finally {
      setIsLoading(false);
    }
  };

  if (!isOpen) return null;

  const nearestExpiry = product.batches.length > 0
    ? product.batches.reduce((min, b) => 
        new Date(b.expiryDate) < new Date(min.expiryDate) ? b : min
      )
    : null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg w-full max-w-md mx-4 overflow-hidden">
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b">
          <h2 className="text-lg font-semibold">{t('collection.title')}: {product.name}</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>

        {/* Content */}
        <div className="p-4 space-y-4">
          {/* Stock info */}
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">{t('collection.in_stock')}:</span>
            <span className="font-medium">{product.totalQuantity} —à—Ç</span>
          </div>

          {nearestExpiry && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">{t('collection.nearest_expiry')}:</span>
              <span className={`font-medium ${nearestExpiry.daysUntilExpiry <= 3 ? 'text-red-600' : ''}`}>
                {new Date(nearestExpiry.expiryDate).toLocaleDateString()} 
                ({nearestExpiry.daysUntilExpiry} –¥–Ω.)
              </span>
            </div>
          )}

          {/* Batches list */}
          <div className="border rounded-lg p-3 bg-gray-50 max-h-32 overflow-y-auto">
            <div className="text-xs text-gray-500 mb-2">{t('collection.batches')}:</div>
            {product.batches.map(batch => (
              <div key={batch.id} className="flex justify-between text-sm py-1">
                <span className={`
                  ${batch.status === 'EXPIRED' ? 'text-red-600' : ''}
                  ${batch.status === 'CRITICAL' ? 'text-orange-600' : ''}
                  ${batch.status === 'WARNING' ? 'text-yellow-600' : ''}
                  ${batch.status === 'OK' ? 'text-green-600' : ''}
                `}>
                  {new Date(batch.expiryDate).toLocaleDateString()}
                </span>
                <span>{batch.quantity} —à—Ç</span>
              </div>
            ))}
          </div>

          {/* Quantity selector */}
          <div>
            <label className="block text-sm font-medium mb-2">
              {t('collection.quantity')}:
            </label>
            <div className="flex items-center gap-4">
              <button
                onClick={() => setQuantity(Math.max(1, quantity - 1))}
                className="w-10 h-10 rounded-lg border flex items-center justify-center hover:bg-gray-100"
              >
                <Minus size={18} />
              </button>
              <input
                type="number"
                value={quantity}
                onChange={(e) => setQuantity(Math.max(1, Math.min(product.totalQuantity, parseInt(e.target.value) || 1)))}
                className="w-24 text-center text-xl font-bold border rounded-lg py-2"
                min={1}
                max={product.totalQuantity}
              />
              <button
                onClick={() => setQuantity(Math.min(product.totalQuantity, quantity + 1))}
                className="w-10 h-10 rounded-lg border flex items-center justify-center hover:bg-gray-100"
              >
                <Plus size={18} />
              </button>
            </div>
          </div>

          {/* Reason selector */}
          <div>
            <label className="block text-sm font-medium mb-2">{t('collection.reason')}:</label>
            <div className="space-y-2">
              {REASONS.map(r => (
                <label key={r.value} className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name="reason"
                    value={r.value}
                    checked={reason === r.value}
                    onChange={(e) => setReason(e.target.value)}
                    className="w-4 h-4"
                  />
                  <span>{t(r.labelKey)}</span>
                </label>
              ))}
            </div>
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm font-medium mb-2">{t('collection.notes')}:</label>
            <textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              className="w-full border rounded-lg p-2 text-sm"
              rows={2}
              placeholder={t('collection.notes_placeholder')}
            />
          </div>

          {/* FIFO Preview */}
          {preview.length > 0 && (
            <div className="border-t pt-3">
              <div className="text-sm text-gray-600 mb-2">{t('collection.preview')}:</div>
              {preview.map(p => {
                const batch = product.batches.find(b => b.id === p.batchId);
                return (
                  <div key={p.batchId} className="text-sm flex justify-between">
                    <span>‚Ä¢ {batch ? new Date(batch.expiryDate).toLocaleDateString() : p.batchId}</span>
                    <span className="font-medium">-{p.toCollect} —à—Ç</span>
                  </div>
                );
              })}
            </div>
          )}

          {/* Error */}
          {error && (
            <div className="flex items-center gap-2 text-red-600 text-sm">
              <AlertTriangle size={16} />
              {error}
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="flex gap-3 p-4 border-t bg-gray-50">
          <button
            onClick={onClose}
            className="flex-1 py-2 border rounded-lg hover:bg-gray-100"
          >
            {t('collection.cancel')}
          </button>
          <button
            onClick={handleSubmit}
            disabled={isLoading || quantity <= 0 || quantity > product.totalQuantity}
            className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {isLoading ? '...' : `${t('collection.submit')} ${quantity} —à—Ç`}
          </button>
        </div>
      </div>
    </div>
  );
}
```

#### 8.5 –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é
–§–∞–π–ª: `frontend/src/locales/ru.json` (–¥–æ–±–∞–≤–∏—Ç—å):
```json
{
  "collection": {
    "title": "–°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞",
    "quantity": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è",
    "reason": "–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è",
    "reasons": {
      "collected": "–°–æ–±—Ä–∞–Ω–æ/–ü—Ä–æ–¥–∞–Ω–æ",
      "expired": "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ",
      "damaged": "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–æ",
      "other": "–î—Ä—É–≥–æ–µ"
    },
    "notes": "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
    "notes_placeholder": "–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ...",
    "preview": "–ë—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ –∏–∑",
    "submit": "–°–ø–∏—Å–∞—Ç—å",
    "cancel": "–û—Ç–º–µ–Ω–∞",
    "success": "–£—Å–ø–µ—à–Ω–æ —Å–ø–∏—Å–∞–Ω–æ {count} —à—Ç",
    "error": {
      "insufficient": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ",
      "invalid_quantity": "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ",
      "general": "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏"
    },
    "in_stock": "–ù–∞ —Å–∫–ª–∞–¥–µ",
    "nearest_expiry": "–ë–ª–∏–∂–∞–π—à–∏–π —Å—Ä–æ–∫",
    "batches": "–ü–∞—Ä—Ç–∏–∏"
  }
}
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–∞–∑—ã 8
- [ ] Collection –º–æ–¥–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å batchSnapshot
- [ ] CollectionService —Å FIFO –ª–æ–≥–∏–∫–æ–π —Å–æ–∑–¥–∞–Ω
- [ ] API endpoint /api/collections/collect —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Preview endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç CollectProductModal —Å–æ–∑–¥–∞–Ω
- [ ] –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ (ru, en, kk)
- [ ] FIFO —Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ü–∞—Ä—Ç–∏–∏ —Å quantity=0 —É–¥–∞–ª—è—é—Ç—Å—è
- [ ] –ò—Å—Ç–æ—Ä–∏—è —Å–ø–∏—Å–∞–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç snapshot –ø–∞—Ä—Ç–∏–π
- [ ] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã

---

## Checklist –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å:
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –¢–µ—Å—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å) –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
- [ ] –ù–µ—Ç console.error –≤ –ª–æ–≥–∞—Ö
- [ ] Git commit —Å–¥–µ–ª–∞–Ω —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º

### –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–∑:

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] HOTEL_ADMIN –Ω–µ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å SUPER_ADMIN
- [ ] –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- [ ] Permissions –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º endpoint

#### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- [ ] –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º" –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–¥—Ä—É–≥–æ–µ"
- [ ] –ò—Å—Ç–æ—Ä–∏—è —Å–±–æ—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏
- [ ] –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª–Ω—ã–π –∏ —á–∏—Ç–∞–µ–º—ã–π
- [ ] Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –≠–∫—Å–ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è
- [ ] –°–±–æ—Ä –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å FIFO —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- [ ] –ó–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è < 500ms
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –Ω–∞ –≤—Å–µ—Ö foreign keys
- [ ] –ù–µ—Ç N+1 queries

#### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- [ ] README –æ–±–Ω–æ–≤–ª—ë–Ω
- [ ] API endpoints –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω—ã

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–æ–ª–∏ Department Manager** - —Ç–µ–ø–µ—Ä—å —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ permissions
2. **–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–∞–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é —Ñ–∏—á—É
3. **–£—á—ë—Ç –ø—Ä–æ–¥–∞–∂** - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
4. **–¢–µ—Å—Ç—ã** - –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
5. **Monitoring** - –¥–æ–±–∞–≤–∏—Ç—å Sentry/LogRocket
6. **Performance optimization** - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, CDN
7. **Quick Actions** - –∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è (5, 10, 25 —à—Ç)
8. **Bulk Collection** - –º–∞—Å—Å–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
9. **Mobile PWA** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
