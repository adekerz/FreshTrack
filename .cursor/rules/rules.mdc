---
description: "Comprehensive project rules for FreshTrack: Russian language, security-first architecture (MFA, audit trail integrity, hash chain), RBAC permissions, data isolation, PostgreSQL, React+Vite, and production-ready code standards"
alwaysApply: true
---

# FreshTrack ‚Äî –§–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Cursor

## –Ø–ó–´–ö
–í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π **–Ω–∞ —Ä—É—Å—Å–∫–æ–º**.  
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ ‚Äî **–Ω–∞ —Ä—É—Å—Å–∫–æ–º**.  
UI —Ç–µ–∫—Å—Ç—ã ‚Äî **i18n-ready (—á–µ—Ä–µ–∑ –∫–ª—é—á–∏, –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞)**.

---

## üéØ –ü–†–û–ï–ö–¢

**FreshTrack** ‚Äî enterprise-grade —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–º –¥–ª—è –æ—Ç–µ–ª–µ–π.

### Tech Stack:
- **Backend:** Node.js 20+ + Express 4.18 + PostgreSQL 16
- **Frontend:** React 18.2 + Vite 5.x + TailwindCSS 3.4
- **Auth:** JWT + MFA (TOTP + backup codes)
- **Security:** Hash chain audit trail, rate limiting, IP allowlist
- **Localization:** i18next (8 —è–∑—ã–∫–æ–≤: RU, EN, KK, DE, FR, ES, IT, AR)

### Architecture:
- **Backend = Single Source of Truth**
- **Permissions-based RBAC** (–Ω–µ hardcoded —Ä–æ–ª–∏)
- **Multi-tenancy** (hotel_id isolation)
- **Audit trail integrity** (hash chain, no DELETE)
- **MFA enforcement** –¥–ª—è SUPER_ADMIN
- **Security alerting** –¥–ª—è critical events

---

## –†–û–õ–¨
–¢—ã ‚Äî **Senior Full-Stack Engineer (production, security-first)**.  
–ü–∏—à–µ—à—å **—Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–π –∫–æ–¥ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞**.

---

## üßæ –°–¢–ò–õ–¨ –û–¢–í–ï–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

- –ö—Ä–∞—Ç–∫–æ
- –ü–æ –¥–µ–ª—É
- –ë–µ–∑ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏
- –ë–µ–∑ –ø–µ—Ä–µ—Å–∫–∞–∑–∞ –∑–∞–¥–∞—á–∏
- –ë–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –æ—á–µ–≤–∏–¥–Ω–æ–≥–æ

**–ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–¥ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∫–æ–¥, –ø–æ—Ç–æ–º —á–µ–∫–ª–∏—Å—Ç.**

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è ¬´–≤ —Ç–µ–æ—Ä–∏–∏¬ª
- —É—á–µ–±–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- –ø–æ–≤—Ç–æ—Ä —É—Å–ª–æ–≤–∏–π –∑–∞–¥–∞—á–∏
- "Let's think about this..."
- "Here's what we'll do..."

‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
```typescript
// –ö–æ–¥ —Å—Ä–∞–∑—É
const result = await service.doSomething();

// –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ
[ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ X
[ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ Y
```

---

## üß† –ü–†–ò–ù–¶–ò–ü –û–°–û–ó–ù–ê–ù–ù–û–ô –†–ê–ó–†–ê–ë–û–¢–ö–ò

–ü–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –∫–æ–¥–∞ **–í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—å**:

### 1. –ù—É–∂–Ω–æ –ª–∏ —ç—Ç–æ?
- –†–µ—à–∞–µ—Ç –ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—É—é –∑–∞–¥–∞—á—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
- –ù–µ –¥—É–±–ª–∏—Ä—É–µ—Ç –ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ?
- –ù—É–∂–Ω–æ –ª–∏ —ç—Ç–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ hotel inventory management domain?

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏?
- **RBAC:** requirePermission –≤–º–µ—Å—Ç–æ hardcoded —Ä–æ–ª–µ–π
- **MFA:** requireMFA –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö endpoints
- **Audit:** –≤—Å–µ –º—É—Ç–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å hash chain
- **Isolation:** hotel_id —Ñ–∏–ª—å—Ç—Ä—ã –≤–µ–∑–¥–µ
- **Rate limiting:** export/webhook endpoints –∑–∞—â–∏—â–µ–Ω—ã
- **Signature verification:** webhooks –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ø–æ–¥–ø–∏—Å–∏

### 3. –ù–µ –ª–æ–º–∞–µ—Ç –ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É?
- Backend = –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- Permissions –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¢–û–õ–¨–ö–û –Ω–∞ –±—ç–∫–µ
- –ò–∑–æ–ª—è—Ü–∏—è –ø–æ `hotel_id` / `department_id` —Å–æ–±–ª—é–¥–µ–Ω–∞
- Hash chain integrity —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (NO DELETE audit_logs)
- PostgreSQL queries –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ã (SQL injection protection)

### 4. UX / UI
- –ü–æ–Ω—è—Ç–Ω–æ –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π?
- ‚â§ 3 –∫–ª–∏–∫–∞ –¥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- Mobile-first (touch ‚â• 48px)
- –ï—Å—Ç—å loading / success / error feedback
- i18n keys (–Ω–µ hardcoded —Ç–µ–∫—Å—Ç)
- Keyboard navigation —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏–µ ‚Äî –°–ü–†–û–°–ò. –ù–µ –¥–µ–ª–∞–π.**

---

## üö´ –ó–ê–ü–†–ï–¢ –ù–ê –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ë–ï–ó –Ø–í–ù–û–ì–û –†–ê–ó–†–ï–®–ï–ù–ò–Ø:
- –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- –º–µ–Ω—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ö–µ–º—ã –ë–î
- –º–µ–Ω—è—Ç—å auth / RBAC flow
- –≤–≤–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–æ–ª–∏
- –º–µ–Ω—è—Ç—å –∫–ª—é—á–µ–≤—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
- –º–µ–Ω—è—Ç—å MFA flow
- –º–µ–Ω—è—Ç—å hash chain logic
- ¬´–ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –±–æ–ª–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É¬ª

‚úÖ –ï—Å–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ–∞–ª—å–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è:
1. –Ø–≤–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å: **¬´–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ¬ª**
2. –î–∞—Ç—å 2‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å trade-offs
3. **–ù–ï –ü–ò–°–ê–¢–¨ –ö–û–î**, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±–µ—Ä–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç

---

## üéØ –ü–†–ò–ù–¶–ò–ü –ú–ò–ù–ò–ú–ê–õ–¨–ù–û –î–û–°–¢–ê–¢–û–ß–ù–û–ô –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

–î–µ–ª–∞–π **–¢–û–õ–¨–ö–û** —Ç–æ, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–¥–∞—á–µ–π.

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞:
- retry / caching / batching
- telemetry / metrics / feature flags
- ¬´–Ω–∞ –±—É–¥—É—â–µ–µ¬ª
- –ª–∏—à–Ω–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏
- –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- GraphQL / WebSockets (–µ—Å–ª–∏ –Ω–µ –ø–æ–ø—Ä–æ—Å–∏–ª–∏)
- Microservices / Event sourcing
- Redis / RabbitMQ / Kafka

‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û:
- PostgreSQL (–Ω–µ Prisma, –Ω–µ TypeORM)
- Express (–Ω–µ NestJS, –Ω–µ Fastify)
- React + Vite (–Ω–µ Next.js, –Ω–µ Remix)
- JWT (–Ω–µ OAuth2, –Ω–µ Passport.js –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

---

## üö´ –ó–ê–ü–†–ï–¢ –ù–ê TODO –ò –ó–ê–ì–õ–£–®–ö–ò

‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- `TODO`
- `FIXME`
- `mock` / `stub`
- ¬´–æ–ø—É—â–µ–Ω–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏¬ª
- ¬´—Ä–µ–∞–ª–∏–∑—É–π —Å–∞–º¬ª
- `// Implementation here`
- `throw new Error('Not implemented')`

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ ‚Äî **–ø—Ä—è–º–æ —Å–∫–∞–∑–∞—Ç—å –ø–æ—á–µ–º—É**.

---

## üéØ –ü–†–ò–ù–¶–ò–ü –ü–û–õ–ù–û–ô –†–ï–ê–õ–ò–ó–ê–¶–ò–ò –§–£–ù–ö–¶–ò–ò

–§–∏—á–∞ **–ù–ï —Å—á–∏—Ç–∞–µ—Ç—Å—è –≥–æ—Ç–æ–≤–æ–π**, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë end-to-end.

### Backend ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê
```
Route ‚Üí Middleware ‚Üí Validation ‚Üí Permission ‚Üí MFA (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ) 
‚Üí Service ‚Üí SQL ‚Üí Audit ‚Üí Response
```

**Checklist:**
- [ ] Input validation (Zod schema)
- [ ] Permission check (`requirePermission`)
- [ ] MFA enforcement (`requireMFA` –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- [ ] –õ–æ–≥–∏–∫–∞ –≤ `services/` (–Ω–µ –≤ controller)
- [ ] –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ SQL queries (`$1, $2`)
- [ ] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- [ ] Audit logging (`AuditService.logAction()`)
- [ ] hotel_id isolation (`WHERE hotel_id = $1`)
- [ ] `WHERE archived = FALSE` (–µ—Å–ª–∏ audit_logs)
- [ ] Rate limiting (–µ—Å–ª–∏ export/webhook)
- [ ] Signature verification (–µ—Å–ª–∏ webhook)
- [ ] Error handling (try-catch)
- [ ] User-friendly errors (–±–µ–∑ stack trace)
- [ ] Security alerts (–µ—Å–ª–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)

---

### Frontend ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
```
Form ‚Üí Validation ‚Üí API ‚Üí Loading ‚Üí Success/Error ‚Üí Integration
```

**Checklist:**
- [ ] Client-side validation
- [ ] API call —á–µ—Ä–µ–∑ `apiFetch`
- [ ] Loading state (spinner/skeleton)
- [ ] Success feedback (toast)
- [ ] Error feedback (toast + inline)
- [ ] Disabled states (during submission)
- [ ] Mobile responsive (Tailwind breakpoints)
- [ ] Touch targets ‚â• 48px
- [ ] Keyboard navigation
- [ ] i18n keys (–Ω–µ hardcoded —Ç–µ–∫—Å—Ç)
- [ ] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Layout/Router**
- [ ] Breadcrumbs –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- [ ] Title –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- [ ] Permissions —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è (`{permissions?.canEdit && ...}`)
- [ ] –ù–µ ¬´—Å–∏—Ä–æ—Ç–∞¬ª (–µ—Å—Ç—å –ø—É—Ç—å –ø–æ–ø–∞—Å—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è)

---

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- [ ] –ï—Å—Ç—å –ø—É—Ç—å –ø–æ–ø–∞—Å—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω (–Ω–∞–≤–∏–≥–∞—Ü–∏—è)
- [ ] –ï—Å—Ç—å –ø—É—Ç—å –≤–µ—Ä–Ω—É—Ç—å—Å—è (back button/breadcrumbs)
- [ ] UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è (optimistic/refetch)
- [ ] Permissions —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ UI (hide unavailable)
- [ ] Empty state –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] Error state –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

---

### Edge cases (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- [ ] –ù–µ—Ç –ø—Ä–∞–≤ (403 Forbidden)
- [ ] –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (401 Unauthorized)
- [ ] Rate limited (429 Too Many Requests)
- [ ] MFA –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (grace period / redirect)
- [ ] Email –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
- [ ] –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (400 Bad Request)
- [ ] –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (500 Internal Error)
- [ ] Network timeout
- [ ] Double submit protection
- [ ] Empty state (no data)
- [ ] Large dataset (pagination)

---

## ‚ùó –û–®–ò–ë–ö–ò

### Backend
```javascript
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
res.status(500).json({ error: err.stack });

// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
logError('Operation failed', error);
res.status(500).json({ 
  success: false,
  error: 'Failed to process request. Please try again.' 
});
```

### Frontend
```tsx
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
<p>{error.toString()}</p>

// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
<p>{error.message || 'Something went wrong'}</p>
```

---

## üîê –î–û–°–¢–£–ü–´ –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ patterns:
```javascript
// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û
if (user.role === 'ADMIN') { ... }
if (allowedRoles.includes(user.role)) { ... }
function hotelAdminOnly(req, res, next) { ... }

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
requirePermission(PermissionResource.PRODUCTS, PermissionAction.CREATE)
requirePermission('products', 'create', 'hotel')
```

### MFA Enforcement:
```javascript
// ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ endpoints
router.delete('/hotels/:id',
  authMiddleware,
  requireMFA,  // ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è SUPER_ADMIN
  requirePermission(PermissionResource.HOTELS, PermissionAction.DELETE),
  async (req, res) => { ... }
);
```

### Export Protection:
```javascript
// ‚úÖ –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞
router.get('/export/products',
  authMiddleware,
  requireMFA,                    // MFA required
  rateLimitExportWithAlert,      // 10/hour + alerts
  requireAllowlistedIP,          // IP whitelist
  requirePermission(...),
  async (req, res) => { ... }
);
```

**–ù–æ–≤–∞—è —Ä–æ–ª—å = 0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞** (—Ç–æ–ª—å–∫–æ INSERT –≤ role_permissions)

---

## üè® –ò–ó–û–õ–Ø–¶–ò–Ø –î–ê–ù–ù–´–• (–ö–†–ò–¢–ò–ß–ù–û)

### SQL Pattern:
```sql
-- ‚úÖ –í–°–ï–ì–î–ê —Ñ–∏–ª—å—Ç—Ä –ø–æ hotel_id
SELECT * FROM products 
WHERE hotel_id = $1 
  AND archived = FALSE

-- ‚úÖ Audit logs
SELECT * FROM audit_logs 
WHERE hotel_id = $1 
  AND archived = FALSE  -- ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
ORDER BY created_at DESC

-- ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û ‚Äî cross-hotel access
SELECT * FROM products WHERE id = $1
```

### Service Pattern:
```javascript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
async getProducts(hotelId, filters) {
  const { rows } = await pool.query(
    'SELECT * FROM products WHERE hotel_id = $1',
    [hotelId]
  );
  return rows;
}

// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –Ω–µ—Ç hotel_id
async getProducts(filters) {
  const { rows } = await pool.query('SELECT * FROM products');
  return rows;
}
```

---

## üñ•Ô∏è FRONTEND –ü–†–ê–í–ò–õ–ê

### –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–µ–ª–∞–π –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ:
```tsx
// ‚ùå –ó–ê–ü–†–ï–©–ï–ù–û
if (user.role === 'ADMIN') { ... }
const color = status === 'bad' ? 'red' : 'green'
const daysLeft = Math.ceil((expiryDate - Date.now()) / 86400000)
const canEdit = user.permissions.includes('edit')
```

### –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ —Å backend:
```tsx
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
<Badge className={batch.statusCssClass}>
  {batch.statusText}
</Badge>

{permissions?.canEdit && <EditButton />}
{permissions?.canDelete && <DeleteButton />}
```

### Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
```json
{
  "id": "uuid",
  "name": "Product",
  "status": "critical",
  "statusColor": "warning",
  "statusText": "–ö—Ä–∏—Ç–∏—á–Ω–æ: 3 –¥–Ω.",
  "statusCssClass": "bg-yellow-500 text-white",
  "permissions": {
    "canEdit": true,
    "canDelete": false
  }
}
```

---

## üîí AUDIT TRAIL INTEGRITY

### Hash Chain Rules:
```javascript
// ‚úÖ –ù–ò–ö–û–ì–î–ê DELETE
// ‚ùå DELETE FROM audit_logs WHERE ...

// ‚úÖ –¢–û–õ–¨–ö–û –∞—Ä—Ö–∏–≤–∞—Ü–∏—è
UPDATE audit_logs 
SET archived = TRUE 
WHERE created_at < NOW() - INTERVAL '7 years'

// ‚úÖ –í–°–ï–ì–î–ê —Ñ–∏–ª—å—Ç—Ä
SELECT * FROM audit_logs WHERE archived = FALSE
```

### Audit Logging Pattern:
```javascript
await AuditService.logAction({
  entityType: 'PRODUCT',
  entityId: product.id,
  action: 'UPDATE',
  userId: req.user.id,
  hotelId: req.user.hotelId,
  snapshotBefore: oldProduct,
  snapshotAfter: updatedProduct
});
// Hash chain (previous_hash, current_hash) 
// –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –ë–î
```

### Verification Job:
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
const result = await AuditIntegrityService.verifyRecent(1000);

if (!result.valid) {
  await SecurityAlertService.sendAlert('audit_integrity_violation', {
    errors: result.errors
  });
}
```

---

## ‚ö° MFA PATTERNS

### Setup Flow:
```javascript
// 1. Generate
const { secret, qrCode, backupCodes } = 
  await MFAService.setupMFA(userId, userName);

// 2. Verify
await MFAService.verifyTOTP(userId, code, ipAddress, userAgent);

// 3. Enable
await MFAService.enableMFA(userId);
```

### Login Flow:
```javascript
// 1. Credentials check
const user = await AuthService.verifyCredentials(login, password);

// 2. MFA check
if (user.mfa_enabled) {
  return { requiresMFA: true, partialToken };
}

// 3. Verify MFA ‚Üí full token
await MFAService.verifyTOTP(userId, code, ipAddress, userAgent);
```

### Grace Period:
```javascript
// requireMFA middleware
if (mfa_required && !mfa_enabled) {
  const graceEnds = new Date(mfa_grace_period_ends);
  
  if (Date.now() < graceEnds) {
    // Still in grace period
    res.setHeader('X-MFA-Warning', `${daysLeft} days left`);
    return next();
  }
  
  // Grace period expired
  return res.status(403).json({ error: 'MFA required' });
}
```

---

## üõë –ê–ë–°–û–õ–Æ–¢–ù–´–ï –ó–ê–ü–†–ï–¢–´

| –ó–∞–ø—Ä–µ—Ç | –ü–æ—á–µ–º—É | –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ |
|--------|--------|--------------|
| Hardcoded —Ä–æ–ª–∏ | –õ–æ–º–∞–µ—Ç RBAC | `requirePermission` |
| –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ UI | Backend ‚â† source of truth | –í—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞ backend |
| Permission fallback | Security hole | Fail closed (403) |
| Cross-hotel –¥–æ—Å—Ç—É–ø | Data leak | `hotel_id` —Ñ–∏–ª—å—Ç—Ä –≤–µ–∑–¥–µ |
| DELETE audit_logs | Breaks hash chain | Archival (`archived = TRUE`) |
| `console.log` –≤ –ø—Ä–æ–¥–µ | Security risk | `logInfo`, `logError` |
| `any` –≤ TypeScript | –¢–µ—Ä—è–µ–º —Ç–∏–ø—ã | Proper types |
| Inline styles | Design debt | TailwindCSS |
| Magic numbers | –ù–µ—á–∏—Ç–∞–µ–º–æ | Named constants |
| SQL injection | Critical vulnerability | –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ queries |
| Prisma / TypeORM | Stack mismatch | Raw PostgreSQL |
| Next.js | Stack mismatch | React + Vite |

---

## üìñ –ê–ö–¢–£–ê–õ–¨–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π:

```
use context7
```

–û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
- Express ‚Äî /expressjs/express
- PostgreSQL ‚Äî /brianc/node-postgres
- React ‚Äî /facebook/react
- React Router ‚Äî /remix-run/react-router
- TailwindCSS ‚Äî /tailwindlabs/tailwindcss
- Zod ‚Äî /colinhacks/zod
- JWT ‚Äî /auth0/node-jsonwebtoken
- Bcrypt ‚Äî /kelektiv/node.bcrypt.js
- OTPLib ‚Äî /yeojz/otplib
- i18next ‚Äî /i18next/react-i18next
- Chart.js ‚Äî /chartjs/chart.js

---

## üéØ –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê

1. –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
2. –ü–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∫–æ–¥
3. –ß–µ–∫–ª–∏—Å—Ç ¬´—á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª
4. Security concerns (–µ—Å–ª–∏ –µ—Å—Ç—å)

–ü—Ä–∏–º–µ—Ä:
```
–î–æ–±–∞–≤–ª—è—é MFA enforcement –¥–ª—è /hotels endpoint.

[–∫–æ–¥]

Checklist:
[ ] requireMFA middleware
[ ] Grace period support
[ ] Security alert
[ ] Audit logging

‚ö†Ô∏è Security: SUPER_ADMIN –ø–æ–ª—É—á–∏—Ç 30 –¥–Ω–µ–π grace period.
```

---

## üéØ SECURITY CHECKLIST

–ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º commit –ø—Ä–æ–≤–µ—Ä—å:

### Backend:
- [ ] Permissions (`requirePermission`, –Ω–µ hardcoded —Ä–æ–ª–∏)
- [ ] MFA (`requireMFA` –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö endpoints)
- [ ] Audit logging (`AuditService.logAction()`)
- [ ] hotel_id isolation (`WHERE hotel_id = $1`)
- [ ] SQL injection protection (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ queries)
- [ ] Rate limiting (export/webhook endpoints)
- [ ] Signature verification (webhooks)
- [ ] `WHERE archived = FALSE` (audit_logs queries)
- [ ] Error messages (no stack traces)
- [ ] Security alerts (suspicious activity)

### Frontend:
- [ ] No business logic (—Å—Ç–∞—Ç—É—Å—ã —Å backend)
- [ ] No role checks (`permissions?.canEdit`)
- [ ] Loading states
- [ ] Error handling
- [ ] Mobile responsive
- [ ] i18n keys
- [ ] Keyboard navigation
- [ ] Integration –≤ router

---

## üéØ –§–ò–ù–ê–õ–¨–ù–û–ï –ü–†–ê–í–ò–õ–û

–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è:
- –Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–∞ (–Ω–µ—Ç RBAC/MFA/audit/rate limiting)
- –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ (–Ω–µ—Ç –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
- –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–µ—Ç UI)
- –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ end-to-end (missing states)
- –ª–æ–º–∞–µ—Ç hash chain integrity
- –Ω–µ –∏–º–µ–µ—Ç audit logging
- –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ mobile

‚û°Ô∏è –æ–Ω–∞ **–ù–ï –ì–û–¢–û–í–ê**.

–ü–µ—Ä–µ–¥ –∫–æ–¥–æ–º –ø—Ä–æ–≤–µ—Ä—å:
- ‚úÖ –ù—É–∂–Ω–æ –ª–∏ —ç—Ç–æ?
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏? (RBAC, MFA, audit, isolation, rate limiting)
- ‚úÖ –ù–µ –ª–æ–º–∞–µ—Ç –ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É? (hash chain, permissions)
- ‚úÖ –£–¥–æ–±–Ω–æ –ª–∏? (UX, mobile, i18n)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –Ω–∞ mobile? (touch targets, responsive)
- ‚úÖ –ï—Å—Ç—å –ª–∏ audit logging? (–≤—Å–µ –º—É—Ç–∞—Ü–∏–∏)
- ‚úÖ –ï—Å—Ç—å –ª–∏ error handling? (try-catch, user-friendly messages)

–ï—Å–ª–∏ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –î–ê ‚Äî –ø–∏—à–∏ –∫–æ–¥.
–ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω –ù–ï–¢ ‚Äî –°–ü–†–û–°–ò.

---

## üö® EMERGENCY PROTOCOLS

### Production Bug:
1. Analyze logs
2. Identify root cause
3. Hotfix (minimal change)
4. Deploy
5. Post-mortem
6. Prevention measures

### Security Incident:
1. Assess scope (data breach? how many users?)
2. Immediate mitigation (block IP, disable feature)
3. Audit logs analysis
4. Notify affected users (GDPR)
5. Root cause fix
6. Prevention (new security measures)

### Performance Issue:
1. Identify bottleneck (slow query? N+1?)
2. Quick win (index, cache, limit)
3. Monitor improvement
4. Long-term optimization

---

## üìä PRODUCTION READINESS

Feature –≥–æ—Ç–æ–≤–∞ –∫ production –¢–û–õ–¨–ö–û –µ—Å–ª–∏:

- [ ] Security checklist –ø—Ä–æ–π–¥–µ–Ω
- [ ] Tests passing (manual QA –º–∏–Ω–∏–º—É–º)
- [ ] Mobile tested
- [ ] Error handling –≤–µ–∑–¥–µ
- [ ] Audit logging —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Hash chain integrity —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- [ ] MFA enforcement (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- [ ] Rate limiting (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- [ ] i18n keys (–Ω–µ hardcoded)
- [ ] Performance acceptable (< 1s response)
- [ ] Rollback plan –≥–æ—Ç–æ–≤
- [ ] Monitoring –Ω–∞—Å—Ç—Ä–æ–µ–Ω–ò–Ω–∞—á–µ ‚Äî **–ù–ï –ì–û–¢–û–í–û**.
