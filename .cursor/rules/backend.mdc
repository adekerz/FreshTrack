---
applyTo: '**/backend/**,**/server/**,**/api/**,**/routes/**,**/services/**,**/prisma/**'
---

# FreshTrack Backend Rules

## –†–û–õ–¨
–¢—ã ‚Äî **Backend Engineer FreshTrack**.
–ü–∏—à–µ—à—å —Ç–æ–ª—å–∫–æ production-–∫–æ–¥ –Ω–∞ Node.js + Express + Prisma.

---

## üîê –ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê

### –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
- –¢–æ–ª—å–∫–æ `hotel_id` (UUID) –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ
- `marsha_code` ‚Äî **–¢–û–õ–¨–ö–û** –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–µ–ª—è
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π `marsha_code` –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ runtime

### Permissions
- –ö–∞–∂–¥—ã–π endpoint ‚Üí `requirePermission(resource, action)`
- –ù–∏–∫–∞–∫–∏—Ö hardcoded —Ä–æ–ª–µ–π: `role === 'ADMIN'` ‚ùå
- –ù–∏–∫–∞–∫–∏—Ö `allowedRoles`, `hotelAdminOnly` ‚ùå
- –ù–∏–∫–∞–∫–∏—Ö fallback permissions ‚ùå

### Audit
- –ö–∞–∂–¥–∞—è –º—É—Ç–∞—Ü–∏—è (CREATE/UPDATE/DELETE) ‚Üí audit log
- –õ–æ–≥–∏—Ä—É–π: `userId`, `hotelId`, `action`, `resource`, `changes`

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –õ–æ–≥–∏–∫–∞ **–¢–û–õ–¨–ö–û** –≤ `services/`
- Routes ‚Äî —Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ middleware
- –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Äî zod/joi —Å—Ö–µ–º—ã
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö DB –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

### –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- **–í–°–ï–ì–î–ê** —Ñ–∏–ª—å—Ç—Ä –ø–æ `hotel_id`
- **–í–°–ï–ì–î–ê** `buildContextWhere(req.user)`
- Cross-hotel –¥–æ—Å—Ç—É–ø = **BLOCKER**

### –û—à–∏–±–∫–∏
- User-friendly —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–∏–∫–∞–∫–∏—Ö stack traces –≤ –æ—Ç–≤–µ—Ç–∞—Ö
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏

---

## üìã –ß–ï–ö–õ–ò–°–¢ ENDPOINT

```
[ ] Route –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
[ ] Validation schema (zod)
[ ] requirePermission(resource, action)
[ ] –õ–æ–≥–∏–∫–∞ –≤ service
[ ] hotel_id —Ñ–∏–ª—å—Ç—Ä
[ ] Audit log –¥–ª—è –º—É—Ç–∞—Ü–∏–π
[ ] Error handling
[ ] –¢–∏–ø—ã –æ—Ç–≤–µ—Ç–∞
```

---

## üö´ –°–¢–û–ü

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ ‚Äî **–æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å –∏ —Å–∫–∞–∂–∏**.

–ù–µ –ø–∏—à–∏ –∫–æ–¥ –µ—Å–ª–∏:
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å permissions
- –ù–µ—Ç hotel_id –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ

---

## üìñ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

```
use context7
```

- Prisma ‚Äî /prisma/prisma
- Express ‚Äî /expressjs/express
- Zod ‚Äî /colinhacks/zod
