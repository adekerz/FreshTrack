---
description: "Backend rules for FreshTrack: Node.js/Express/PostgreSQL patterns, RBAC permissions, MFA enforcement, audit trail integrity, data isolation, and security-first architecture"
alwaysApply: false
---

# FreshTrack Backend Rules

## –†–û–õ–¨
–¢—ã ‚Äî **Backend Engineer FreshTrack**.
–ü–∏—à–µ—à—å —Ç–æ–ª—å–∫–æ production-–∫–æ–¥ –Ω–∞ Node.js + Express + PostgreSQL.

---

## üîê –ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê

### Stack
- **Node.js 20+** + Express 4.18
- **PostgreSQL 16** (raw queries —á–µ—Ä–µ–∑ `pool.query()`)
- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º Prisma** ‚Äî —Ç–æ–ª—å–∫–æ SQL
- **JWT** –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **Bcrypt** –¥–ª—è –ø–∞—Ä–æ–ª–µ–π
- **Zod** –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
- –¢–æ–ª—å–∫–æ `hotel_id` (UUID) –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ
- `marsha_code` ‚Äî **–¢–û–õ–¨–ö–û** –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–µ–ª—è
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π `marsha_code` –∫–∞–∫ FK –∏–ª–∏ runtime –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä

### Permissions
- –ö–∞–∂–¥—ã–π endpoint ‚Üí `requirePermission(resource, action, scope)`
- –ù–∏–∫–∞–∫–∏—Ö hardcoded —Ä–æ–ª–µ–π: `role === 'ADMIN'` ‚ùå
- –ù–∏–∫–∞–∫–∏—Ö `allowedRoles`, `hotelAdminOnly` ‚ùå
- –ù–∏–∫–∞–∫–∏—Ö fallback permissions ‚ùå
- Permissions –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `role_permissions`

### MFA Enforcement
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ endpoints ‚Üí `requireMFA` middleware
- SUPER_ADMIN –±–µ–∑ MFA = –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ grace period
- Grace period: 30 –¥–Ω–µ–π —Å `mfa_grace_period_ends`
- Warning headers: `X-MFA-Warning`, `X-MFA-Grace-Period-Ends`

### Audit Logging
- **Hash chain integrity** –¥–ª—è audit_logs
- –ö–∞–∂–¥–∞—è –º—É—Ç–∞—Ü–∏—è ‚Üí `AuditService.logAction()`
- JSONB snapshots: `snapshot_before`, `snapshot_after`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π `previous_hash`, `current_hash`
- **–ù–ò–ö–û–ì–î–ê DELETE audit_logs** ‚Äî —Ç–æ–ª—å–∫–æ archival (`archived = TRUE`)

### Security
- Export endpoints ‚Üí `rateLimitExportWithAlert + requireAllowlistedIP + requireMFA`
- Webhook signature verification (Svix for Resend, secret token for Telegram)
- Rate limiting: user ID (–Ω–µ IP)
- Email verification: secure tokens (–Ω–µ 6-–∑–Ω–∞—á–Ω—ã–µ –∫–æ–¥—ã)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –õ–æ–≥–∏–∫–∞ **–¢–û–õ–¨–ö–û** –≤ `services/`
- Routes ‚Äî —Ç–æ–ª—å–∫–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ middleware
- –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Äî Zod schemas
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö DB –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- –°–µ—Ä–≤–∏—Å—ã: 
  - `MFAService` ‚Äî TOTP + backup codes
  - `AuditIntegrityService` ‚Äî hash chain verification
  - `SecurityAlertService` ‚Äî alerts –¥–ª—è SUPER_ADMIN
  - `ExportService` ‚Äî audit logging –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–æ–≤
  - `EmailService` ‚Äî templates + verification

### –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- **–í–°–ï–ì–î–ê** —Ñ–∏–ª—å—Ç—Ä –ø–æ `hotel_id`
- **–í–°–ï–ì–î–ê** `WHERE archived = FALSE` –¥–ª—è audit_logs
- **–í–°–ï–ì–î–ê** `buildContextWhere(req.user)`
- Cross-hotel –¥–æ—Å—Ç—É–ø = **BLOCKER**

### –û—à–∏–±–∫–∏
- User-friendly —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–∏–∫–∞–∫–∏—Ö stack traces –≤ –æ—Ç–≤–µ—Ç–∞—Ö
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —á–µ—Ä–µ–∑ `logInfo`, `logError`, `logWarn`
- Security events —á–µ—Ä–µ–∑ `SecurityAlertService`

---

## üìã –ß–ï–ö–õ–ò–°–¢ ENDPOINT

### –û–±—ã—á–Ω—ã–π endpoint:
```
[ ] Route –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ router
[ ] Validation schema (Zod)
[ ] requirePermission(resource, action, scope)
[ ] –õ–æ–≥–∏–∫–∞ –≤ service (–Ω–µ –≤ controller)
[ ] hotel_id —Ñ–∏–ª—å—Ç—Ä
[ ] Audit log –¥–ª—è –º—É—Ç–∞—Ü–∏–π (—á–µ—Ä–µ–∑ AuditService)
[ ] Error handling (try-catch)
[ ] –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π response
[ ] WHERE archived = FALSE (–µ—Å–ª–∏ —á–∏—Ç–∞–µ–º audit_logs)
```

### –ö—Ä–∏—Ç–∏—á–Ω—ã–π endpoint (SUPER_ADMIN):
```
[ ] requireMFA middleware
[ ] requirePermission
[ ] superAdminOnly (–µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è SUPER_ADMIN)
[ ] Audit logging
[ ] Security alert –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```

### Export endpoint:
```
[ ] requireMFA
[ ] rateLimitExportWithAlert (10/hour)
[ ] requireAllowlistedIP (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
[ ] ExportService.sendExport() –¥–ª—è audit logging
[ ] Size limit check (MAX_EXPORT_ROWS)
[ ] X-Export-ID header
```

### Webhook endpoint:
```
[ ] Signature verification (Svix/secret token)
[ ] Rate limiting (60/min)
[ ] NO auth middleware (webhooks –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç JWT)
[ ] Idempotency check (prevent double processing)
[ ] Audit logging
```

---

## üõ°Ô∏è SECURITY PATTERNS

### MFA Setup Flow:
```javascript
// 1. Generate secret + QR
const { secret, qrCode, backupCodes } = await MFAService.setupMFA(userId, userName);

// 2. User scans QR ‚Üí enters code
await MFAService.verifyTOTP(userId, code, ipAddress, userAgent);

// 3. Enable MFA
await MFAService.enableMFA(userId);
```

### MFA Login Flow:
```javascript
// 1. Username/password check
const user = await AuthService.verifyCredentials(login, password);

// 2. If MFA enabled ‚Üí partial token
if (user.mfa_enabled) {
  return { requiresMFA: true, partialToken };
}

// 3. Verify MFA code ‚Üí full token
await MFAService.verifyTOTP(userId, code, ipAddress, userAgent);
```

### Audit Logging Pattern:
```javascript
await AuditService.logAction({
  entityType: 'PRODUCT',
  entityId: product.id,
  action: 'UPDATE',
  userId: req.user.id,
  hotelId: req.user.hotelId,
  snapshotBefore: oldProduct,
  snapshotAfter: updatedProduct
});
// Hash chain –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –ë–î
```

### Security Alert Pattern:
```javascript
await SecurityAlertService.sendAlert('audit_integrity_violation', {
  totalRecords: result.totalRecords,
  errorsCount: result.errors.length,
  errors: result.errors.slice(0, 5)
});
// Email –≤—Å–µ–º SUPER_ADMIN + audit log
```

### Export Pattern:
```javascript
const result = await ExportService.sendExport({
  data: products,
  format: 'xlsx',
  filename: 'products',
  sheetName: 'Products',
  user: req.user,
  ipAddress: req.ip,
  userAgent: req.get('user-agent'),
  entityType: 'product'
});

res.setHeader('X-Export-ID', result.exportId);
res.setHeader('Content-Type', result.contentType);
res.setHeader('Content-Disposition', `attachment; filename="${result.filename}"`);
res.send(result.buffer);
```

---

## üóÑÔ∏è DATABASE PATTERNS

### Query Pattern:
```javascript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
const { rows } = await pool.query(
  'SELECT * FROM products WHERE hotel_id = $1 AND id = $2',
  [hotelId, productId]
);

// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî SQL injection
const { rows } = await pool.query(
  `SELECT * FROM products WHERE id = ${productId}`
);
```

### Transaction Pattern:
```javascript
const client = await pool.connect();
try {
  await client.query('BEGIN');
  
  await client.query('UPDATE ...', [...]);
  await client.query('INSERT ...', [...]);
  
  await client.query('COMMIT');
} catch (error) {
  await client.query('ROLLBACK');
  throw error;
} finally {
  client.release();
}
```

### Hotel Isolation Pattern:
```javascript
// ‚úÖ –í–°–ï–ì–î–ê —Ñ–∏–ª—å—Ç—Ä –ø–æ hotel_id
WHERE hotel_id = $1 AND archived = FALSE

// ‚úÖ buildContextWhere –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
const whereClause = buildContextWhere(req.user);
```

---

## üö´ –°–¢–û–ü

–ù–µ –ø–∏—à–∏ –∫–æ–¥ –µ—Å–ª–∏:
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å permissions
- –ù–µ—Ç hotel_id –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
- MFA —Ç—Ä–µ–±—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- –ù—É–∂–Ω–∞ –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ (—Å–ø—Ä–æ—Å–∏ —Å–Ω–∞—á–∞–ª–∞)
- –ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ö–µ–º—É auth/RBAC (—Å–ø—Ä–æ—Å–∏)

---

## üìñ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

```
use context7
```

–û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
- Express ‚Äî /expressjs/express
- PostgreSQL ‚Äî /brianc/node-postgres
- Zod ‚Äî /colinhacks/zod
- JWT ‚Äî /auth0/node-jsonwebtoken
- Bcrypt ‚Äî /kelektiv/node.bcrypt.js
- OTPLib ‚Äî /yeojz/otplib
- QRCode ‚Äî /soldair/node-qrcode

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´

1. **Security first** ‚Äî MFA, audit, isolation
2. **No data leaks** ‚Äî hotel_id —Ñ–∏–ª—å—Ç—Ä—ã –≤–µ–∑–¥–µ
3. **Audit everything** ‚Äî hash chain integrity
4. **User-friendly errors** ‚Äî no stack traces
5. **Performance** ‚Äî indexes, transactions, batching
